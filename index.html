<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <meta name="theme-color" content="#ffb744">
  <title>é›²ä¸¹ã‚ãã‚‰æ­Œå”±æ›²DB</title>

  <link rel="dns-prefetch" href="https://script.google.com">
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="dns-prefetch" href="https://script.googleusercontent.com">
  <link rel="preconnect" href="https://script.googleusercontent.com" crossorigin>

  <link rel="icon" href="/uni-ikura-songs-db/favicon.ico" sizes="any">
  <link rel="icon" href="/uni-ikura-songs-db/favicon-32.png" sizes="32x32" type="image/png">
  <link rel="icon" href="/uni-ikura-songs-db/favicon-16.png" sizes="16x16" type="image/png">
  <link rel="apple-touch-icon" href="/uni-ikura-songs-db/apple-touch-icon.png" sizes="180x180">

  <style>
    :root{
      --bg:#ffb744; --card:#ffffff; --text:#1a1a1a; --muted:#6b7280; --line:#e5e7eb;
      --thead:#ffe0b5; --focus:#3897c9; --pill-bg:#f6f7f9; --link:#2563eb;
    }
    *{box-sizing:border-box}
    body{
      background:var(--bg);color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      line-height:1.7;margin:12px
    }
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:14px;
      padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.06)
    }

    .row{display:flex;gap:8px;align-items:center}
    .row .search{flex:1 1 auto;min-width:0}

    .toolbar{display:none}

    .limit-wrap{display:flex;align-items:center;gap:6px}
    .limit-wrap label{font-size:12px;color:var(--muted);white-space:nowrap}
    #limit{width:auto;min-width:68px;padding:6px 8px;font-size:13px;line-height:1.2}

    /* å¼¾å¹•UI */
    .dm-wrap{display:flex;align-items:center;gap:8px}
    .dm-select-wrap{flex:7 1 0}
    .dm-btn-wrap{flex:3 1 0;display:flex}
    #dm-select{width:100%;padding:6px 10px;font-size:16px;line-height:1.2}
    .btn-full{width:100%}

    input[type="search"],select{
      width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;
      font-size:16px;background:#fff;color:#1a1a1a;outline:none
    }
    input[type="search"]:focus,select:focus,.btn:focus,.btn-pill:focus{
      outline:3px solid var(--focus);outline-offset:2px
    }

    .muted{color:var(--muted);font-size:13px}
    .btn{
      appearance:none;border:1px solid var(--line);background:#fff;color:var(--text);
      border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer;white-space:nowrap
    }
    .btn:hover{background:#f9fafb}
    .btn:active{transform:translateY(1px)}

    .alert{
      display:none;margin-top:10px;padding:10px 12px;border-radius:10px;
      background:#fff7ed;border:1px solid #fdba74;color:#7c2d12;
      gap:8px;align-items:center
    }
    .alert .msg{flex:1 1 auto;min-width:0}
    .alert .msg strong{display:block;font-weight:700;margin-bottom:2px}
    .alert .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
    .alert .actions .btn{
      border-color:#fdba74;background:#fff;border-radius:8px;font-size:13px;padding:7px 10px
    }
    .alert .actions .btn:hover{background:#fff4e5}

    .toast{
      position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
      background:rgba(17,24,39,.92);color:#fff;padding:10px 14px;border-radius:10px;
      font-size:14px;opacity:0;transition:opacity .2s ease
    }
    .toast.show{opacity:1}

    /* ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚° */
    details.debug{margin-top:12px}
    .debug pre{
      white-space:pre-wrap;word-break:break-all;background:#0f172a;color:#e5e7eb;
      padding:10px;border-radius:10px;min-height:60px;font-size:12px;line-height:1.4;overflow:auto
    }

    /* ãƒ†ãƒ¼ãƒ–ãƒ« */
    table{width:100%;border-collapse:collapse;margin-top:10px;table-layout:fixed}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;font-size:15px;vertical-align:top}
    th{position:sticky;top:0;background:var(--thead);z-index:1;font-weight:700}

    /* è¡Œåˆ†å‰²ãƒ†ãƒ¼ãƒ–ãƒ« */
    table.stacked{table-layout:auto}
    table.stacked th, table.stacked td{width:auto !important}
    table.stacked thead th{width:100% !important; white-space:nowrap}
    table.stacked .item-top{background:#fff;border-bottom:none}
    table.stacked .item-ops{background:#fff}
    table.stacked .item-ops td{border-top:none}
    table.stacked .item-top .l1{
      font-size:16px;font-weight:700;display:flex;gap:8px;flex-wrap:wrap;align-items:flex-start
    }
    table.stacked .item-ops .ops{
      display:flex;gap:8px;align-items:center;justify-content:flex-end;
      flex-wrap:wrap;overflow:visible;min-width:0
    }

    .btn-pill{
      display:inline-block;border:1px solid var(--line);background:var(--pill-bg);color:var(--link);
      border-radius:10px;padding:8px 12px;line-height:1.2;text-decoration:none;
      white-space:nowrap;word-break:keep-all;max-width:unset;overflow:hidden;text-overflow:ellipsis
    }
    .btn-pill:hover{background:#eef2f7;text-decoration:none}
    .btn-pill:active{transform:translateY(1px)}

    /* ã‚¹ã‚±ãƒ«ãƒˆãƒ³ */
    .skeleton{
      height:16px;background:#f1f5f9;border-radius:6px;margin:8px 0;
      animation:pulse 1.2s ease-in-out infinite
    }
    @keyframes pulse{
      0%{opacity:.6}50%{opacity:1}100%{opacity:.6}
    }
    @media (prefers-reduced-motion: reduce){
      .skeleton{animation:none}
      .toast{transition:none}
    }

    /* ãƒ¢ãƒã‚¤ãƒ« */
    .mobile-list{display:none}
    @media (max-width:768px){
      table{display:none}
      .mobile-list{display:block;margin-top:10px}
      .item{
        border-bottom:1px solid var(--line);padding:12px 2px;
        display:flex;flex-direction:column;gap:6px
      }
      .l1{
        font-size:16px;line-height:1.6;font-weight:700;
        display:flex;gap:6px;flex-wrap:wrap
      }
      .l1 .sep{opacity:.6}
      .l2{
        display:flex;align-items:center;gap:8px;justify-content:flex-end;
        flex-wrap:nowrap;overflow:hidden
      }
      .l2 .btn-pill{max-width:40vw}
      .btn{padding:8px 12px;font-size:14px}
      .dm-select-wrap{flex:7 1 0}
      .dm-btn-wrap{flex:3 1 0}
    }

    /* === å†é…ç½®ç”¨ï¼ˆåŸºæœ¬ï¼‰ === */
    .ui .row{display:flex;gap:8px;align-items:center;margin-top:8px}
    .ui .row:first-child{margin-top:0}
    .ui .row2 .search{flex:1 1 0;min-width:0}
    .ui .row3 .dm-select-wrap{flex:7 1 0}
    .ui .row3 .dm-btn-wrap{flex:3 1 0}
    .ui .row5{
      justify-content:space-between;gap:10px;align-items:flex-start;flex-wrap:wrap
    }
    .ui .row5 #status{flex:1 1 0}
    .ui .row5 .status-actions{display:flex;gap:8px;flex-wrap:wrap}
    .ui .row5 .status-actions .btn{padding:7px 10px;font-size:13px}

    /* 1åˆ—ç›®ï¼šä»¶æ•° / å¯¾è±¡ï¼ˆæ¨ªä¸¦ã³å›ºå®šï¼‰ */
    .ui .row1{
      display:flex;gap:8px;align-items:center;flex-wrap:nowrap;
    }
    .ui .row1 .limit-wrap,
    .ui .row1 .type-wrap{
      display:flex;align-items:center;gap:6px;flex:0 0 auto;
    }
    .limit-wrap label, .type-wrap label{
      font-size:12px;color:var(--muted);white-space:nowrap;
    }
    #kind{width:auto;min-width:68px;padding:6px 8px;font-size:13px;line-height:1.2}

    /* 4åˆ—ç›®ï¼šä¸¦ã³æ›¿ãˆUI */
    details.sort-panel{width:100%}
    details.sort-panel summary{
      cursor:pointer;list-style:none;display:flex;align-items:center;gap:6px;
      user-select:none;font-weight:700
    }
    details.sort-panel summary::-webkit-details-marker{display:none}
    details.sort-panel .sort-body{
      margin-top:8px;display:flex;gap:8px;flex-wrap:wrap
    }
    .btn-ghost{background:#fff;border:1px dashed var(--line)}
    .btn-ghost:hover{background:#f9fafb}
    .sort-btn{min-width:120px}
  </style>
</head>
<body>

  <!-- æ¤œç´¢UI -->
  <div class="card ui">
    <!-- 1åˆ—ç›®ï¼šä»¶æ•° / å¯¾è±¡ -->
    <div class="row row1">
      <div class="limit-wrap">
        <label for="limit">ä»¶æ•°</label>
        <select id="limit" aria-label="è¡¨ç¤ºä»¶æ•°">
          <option value="20" selected>20ä»¶</option>
          <option value="50">50ä»¶</option>
          <option value="200">200ä»¶</option>
          <option value="all">å…¨ä»¶</option>
        </select>
      </div>

      <div class="type-wrap">
        <label for="kind">å¯¾è±¡</label>
        <select id="kind" aria-label="å¯¾è±¡ãƒ•ã‚£ãƒ«ã‚¿">
          <option value="all" selected>ã™ã¹ã¦</option>
          <option value="æ­Œã£ã¦ã¿ãŸ">æ­Œã£ã¦ã¿ãŸ</option>
          <option value="ã‚·ãƒ§ãƒ¼ãƒˆ">ã‚·ãƒ§ãƒ¼ãƒˆ</option>
        </select>
      </div>
    </div>

    <!-- 2åˆ—ç›®ï¼šæ¥½æ›²æ¤œç´¢ -->
    <div class="row row2">
      <input class="search" id="q" type="search" placeholder="æ›²åï¼ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã§æ¤œç´¢" autocomplete="off">
    </div>

    <!-- 3åˆ—ç›®ï¼šå¼¾å¹•é¸æŠ / ã‚³ãƒ”ãƒ¼ -->
    <div class="row row3 dm-wrap" aria-label="å¼¾å¹•ã‚³ãƒ”ãƒ¼">
      <div class="dm-select-wrap">
        <select id="dm-select" title="å¼¾å¹•ã‚’é¸æŠ">
          <option value="ğŸ£ğŸ§¡ğŸ£ğŸ§¡ğŸ£ğŸ§¡">ğŸ£ğŸ§¡ğŸ£</option>
          <option value="ğŸ£ğŸ§¡ğŸ¶ğŸ£ğŸ§¡ğŸ¶">ğŸ£ğŸ§¡ğŸ¶</option>
        </select>
      </div>
      <div class="dm-btn-wrap">
        <button id="dm-copy" class="btn btn-full" type="button" title="é¸æŠã—ãŸå¼¾å¹•ã‚’ã‚³ãƒ”ãƒ¼">ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>

    <!-- 4åˆ—ç›®ï¼šä¸¦ã³æ›¿ãˆ -->
    <div class="row row4">
      <details class="sort-panel">
        <summary aria-label="ä¸¦ã³æ›¿ãˆã‚’é–‹é–‰">ä¸¦ã³æ›¿ãˆï¼ˆæœ€æ–°æ›²é †ï¼æ›²åé †ï¼ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåé †ï¼‰</summary>
        <div class="sort-body" role="group" aria-label="ä¸¦ã³æ›¿ãˆè¨­å®š">
          <button id="sort-latest-toggle" class="btn sort-btn" type="button" title="æ—¥ä»˜ã§æœ€æ–°é †ã‚’åˆ‡æ›¿">æœ€æ–°æ›²é †â†“</button>
          <button id="sort-title-toggle" class="btn btn-ghost sort-btn" type="button" title="æ›²åã®æ˜‡é™é †ã‚’åˆ‡æ›¿">æ›²åé †â†“</button>
          <button id="sort-artist-toggle" class="btn btn-ghost sort-btn" type="button" title="ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã®æ˜‡é™é †ã‚’åˆ‡æ›¿">ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåé †â†“</button>
        </div>
      </details>
    </div>

    <!-- 5åˆ—ç›®ï¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
    <div class="row row5">
      <div class="muted" id="status" role="status" aria-live="polite">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
      <div class="status-actions">
        <button id="refetch" class="btn" type="button" title="æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—">å†å–å¾—</button>
      </div>
    </div>

    <div id="error-box" class="alert" role="alert" aria-live="assertive">
      <div class="msg"></div>
      <div class="actions"></div>
    </div>

    <details class="debug" id="debug-panel">
      <summary>ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°</summary>
      <pre id="debug-log" aria-live="polite"></pre>
    </details>
  </div>

  <!-- çµæœè¡¨ç¤º -->
  <div class="card" style="margin-top:12px;">
    <div class="muted" id="hint">æ¤œç´¢çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
    <div id="table" style="display:none;"></div>
    <div id="mblist" class="mobile-list" style="display:none;"></div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</div>

  <script>
    /* ===== è¨­å®š ===== */
    const API_URL = 'https://script.google.com/macros/s/AKfycbxf6Ifxokz6W9w6E1KOwQxapCgpZAR1WE1VPn9MDnMIXLfRuLAqZwx9HyVzMyuC6nITJA/exec';
    const SHEET_KEY = 'perf';
    const INITIAL_FETCH = 200;
    const HARD_LIMIT = 20000;

    const JSONP_TIMEOUT_MS = 3800;
    const SHORT_TRY_MS = 1400;
    const MAX_RETRY = 3;
    const IFRAME_WATCHDOG_MS = 10000;

    const MOBILE_MEDIA_QUERY = '(max-width: 768px)';
    const mediaQuery = window.matchMedia(MOBILE_MEDIA_QUERY);

    const debugLog = [];
    const DEBUG_LOG_LIMIT = 100;

    const state = {
      rows: [],
      total: 0,
      fetchedLimit: 0,
      debounce: null,
      lastReqId: 0,
      usedIframe: false,
      pendingHandler: null,
      globalTimer: null,
      shortTimer: null,
      iframeTimer: null,
      iframeReqId: null,
      lastFetchLimit: INITIAL_FETCH,
      sort: { key: 'none', dir: 'desc' },
      isMobile: mediaQuery.matches,
      renderRaf: null
    };

    /* ===== å…±é€š ===== */
    function $(id){ return document.getElementById(id); }

    function setTextIfChanged(el, text){
      if (!el) return;
      if (el.textContent === text) return;
      el.textContent = text;
    }

    function setAriaIfChanged(el, name, value){
      if (!el) return;
      if (el.getAttribute(name) === value) return;
      el.setAttribute(name, value);
    }

    function setStatus(text, opts = {}){
      const el = $('status');
      if (!el) return;
      setTextIfChanged(el, text);
      if (opts.fallback){
        el.dataset.fallback = '1';
      } else {
        delete el.dataset.fallback;
      }
    }

    function clearFallbackFlag(){
      const el = $('status');
      if (el) delete el.dataset.fallback;
    }

    window.onGviz = function(payload){
      clearFallbackFlag();
      if (typeof state.pendingHandler === 'function'){
        state.pendingHandler(payload);
      }
    };

    function logEvent(label, detail){
      try{
        const ts = new Date();
        const line = `[${ts.toISOString()}] ${label}` +
          (detail ? ` ${typeof detail === 'string' ? detail : JSON.stringify(detail)}` : '');
        debugLog.unshift(line);
        if (debugLog.length > DEBUG_LOG_LIMIT) debugLog.pop();
        const el = $('debug-log');
        if (el) el.textContent = debugLog.join('\n');
        console.log('[debug]', label, detail || '');
      }catch(e){
        console.warn('logEvent failed', e);
      }
    }

    function normalize(s){
      return (s || '').toString().toLowerCase().replace(/\s+/g,' ').trim();
    }

    function scheduleSearch(){
      clearTimeout(state.debounce);
      state.debounce = setTimeout(requestRender, 160);
    }

    function showToast(msg){
      const t = $('toast');
      if (!t) return;
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 1400);
    }

    function clearError(){
      const box = $('error-box');
      if (!box) return;
      box.style.display = 'none';
      const msg = box.querySelector('.msg');
      const actions = box.querySelector('.actions');
      if (msg) msg.innerHTML = '';
      if (actions) actions.innerHTML = '';
    }

    function showError(message, {detail = '', retry = false} = {}){
      const box = $('error-box');
      if (!box) return;
      const msg = box.querySelector('.msg');
      const actions = box.querySelector('.actions');
      if (!msg || !actions) return;

      msg.innerHTML = '';
      const title = document.createElement('strong');
      title.textContent = 'é€šä¿¡ã‚¨ãƒ©ãƒ¼';
      const body = document.createElement('div');
      body.textContent = message;
      msg.appendChild(title);
      msg.appendChild(body);

      if (detail){
        const small = document.createElement('div');
        small.className = 'muted';
        small.textContent = detail;
        msg.appendChild(small);
      }

      actions.innerHTML = '';
      if (retry){
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'btn';
        btn.textContent = 'å†è©¦è¡Œ';
        btn.addEventListener('click', () => fetchRows(state.lastFetchLimit || INITIAL_FETCH));
        actions.appendChild(btn);
      }

      box.style.display = 'flex';
    }

    async function copyText(text, {success = 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ', failure = 'ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ'} = {}){
      const value = (text || '').toString().trim();
      if (!value){
        showToast('ã‚³ãƒ”ãƒ¼å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }
      try{
        if (navigator.clipboard && navigator.clipboard.writeText){
          await navigator.clipboard.writeText(value);
        } else {
          const ta = document.createElement('textarea');
          ta.value = value;
          ta.setAttribute('readonly', '');
          ta.style.position = 'absolute';
          ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          ta.remove();
        }
        showToast(`${success}ï¼š${value}`);
      }catch(e){
        console.warn('copy failed', e);
        showToast(`${failure}ã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚`);
      }
    }

    function copyPair(title, artist){
      return copyText(`${(title || '').trim()} / ${(artist || '').trim()}`, {
        success:'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ',
        failure:'ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ'
      });
    }

    // å¼¾å¹•ã‚³ãƒ”ãƒ¼
    (function(){
      const btn = $('dm-copy');
      if (!btn) return;
      btn.addEventListener('click', () => {
        const sel = $('dm-select');
        copyText(sel && sel.value || '', {
          success:'å¼¾å¹•ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ',
          failure:'å¼¾å¹•ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ'
        });
      });
    })();

    function urlFromText(s){
      if (!s) return '';
      const m = String(s).match(/https?:\/\/\S+/);
      return m ? m[0].replace(/[)\]\s]+$/, '') : '';
    }

    function formatYmdLabel(s){
      const m = /^(\d{4})(\d{2})(\d{2})/.exec(String(s || ''));
      return m ? `${m[1]}/${m[2]}/${m[3]}` : null;
    }

    function safeHttpUrl(u){
      if (!u) return '';
      try{
        const url = new URL(String(u));
        return (url.protocol === 'http:' || url.protocol === 'https:') ? url.href : '';
      }catch{
        return '';
      }
    }

    function createLinkPill(href, label, title){
      if (!href) return null;
      const a = document.createElement('a');
      a.href = href;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.className = 'btn-pill';
      a.title = title || label || 'ãƒªãƒ³ã‚¯';
      a.textContent = label || 'ãƒªãƒ³ã‚¯';
      return a;
    }

    function createCopyButton(title, artist){
      const btn = document.createElement('button');
      btn.className = 'btn';
      btn.textContent = 'ã‚³ãƒ”ãƒ¼';
      const label = `${(title || '').trim()} / ${(artist || '').trim()}`.trim();
      btn.title = label ? `${label} ã‚’ã‚³ãƒ”ãƒ¼` : 'æ›²å / ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã‚’ã‚³ãƒ”ãƒ¼';
      btn.setAttribute('aria-label', btn.title);
      btn.addEventListener('click', () => copyPair(title, artist));
      return btn;
    }

    function showSkeleton(){
      const wrap = $('table');
      if (!wrap) return;
      const frag = document.createDocumentFragment();
      for (let i = 0; i < 6; i++){
        const sk = document.createElement('div');
        sk.className = 'skeleton';
        frag.appendChild(sk);
      }
      wrap.replaceChildren(frag);
      wrap.style.display = 'block';
      const listWrap = $('mblist');
      if (listWrap) listWrap.style.display = 'none';
    }

    function clearSkeleton(){
      const wrap = $('table');
      if (wrap){
        wrap.replaceChildren();
        wrap.style.display = 'none';
      }
      const listWrap = $('mblist');
      if (listWrap) listWrap.style.display = 'none';
    }

    function getKindValue(){
      const el = $('kind');
      return el ? el.value : 'all';
    }

    /* ===== ã‚½ãƒ¼ãƒˆé–¢é€£ ===== */
    function parseYmdInt(s){
      const m = /^(\d{4})(\d{2})(\d{2})$/.exec(String(s || '').trim());
      if (!m) return NaN;
      return Number(`${m[1]}${m[2]}${m[3]}`);
    }

    function compareStrings(a, b, {preNormalized = false} = {}){
      const A = preNormalized ? (a || '') : normalize(a);
      const B = preNormalized ? (b || '') : normalize(b);
      if (A < B) return -1;
      if (A > B) return 1;
      return 0;
    }

    function applySort(rows, sort){
      if (!rows || !rows.length) return rows;
      if (!sort || sort.key === 'none') return rows;

      const dir = sort.dir === 'asc' ? 1 : -1;
      const arr = rows.slice();

      if (sort.key === 'date'){
        arr.sort((r1, r2) => {
          const d1 = Number.isFinite(r1.dateInt) ? r1.dateInt : NaN;
          const d2 = Number.isFinite(r2.dateInt) ? r2.dateInt : NaN;
          const n1 = Number.isNaN(d1);
          const n2 = Number.isNaN(d2);
          if (n1 && n2) return 0;
          if (n1) return 1;
          if (n2) return -1;
          return (d1 - d2) * dir;
        });
      }else if (sort.key === 'artist'){
        arr.sort((r1, r2) => compareStrings(r1.artistLower, r2.artistLower, {preNormalized:true}) * dir);
      }else if (sort.key === 'title'){
        arr.sort((r1, r2) => compareStrings(r1.titleLower, r2.titleLower, {preNormalized:true}) * dir);
      }
      return arr;
    }

    /* ===== æç”» ===== */
    function buildFilteredSongs(st){
      const q = normalize(($('q') && $('q').value) || '');
      const rawLimit = $('limit') && $('limit').value || '20';
      const kind = getKindValue();

      const limit = rawLimit === 'all'
        ? Math.min(HARD_LIMIT, st.total || st.rows.length)
        : Math.min(parseInt(rawLimit, 10) || 20, HARD_LIMIT);
      const limitLabel = rawLimit === 'all' ? 'å…¨ä»¶' : `${limit}ä»¶`;

      let filtered = st.rows;

      if (q){
        filtered = filtered.filter(row => {
          const a = row.artistLower;
          const t = row.titleLower;
          return a.includes(q) || t.includes(q);
        });
      }

      if (kind !== 'all'){
        filtered = filtered.filter(([, , cText]) => String(cText || '').trim() === kind);
      }

      filtered = applySort(filtered, state.sort);

      return {
        rows: filtered.slice(0, limit),
        filteredCount: filtered.length,
        limit,
        limitLabel,
        kind,
        query: q
      };
    }

    function buildStatusText(view){
      const {rows, filteredCount, limitLabel, kind, query} = view;
      const kindPart = (kind !== 'all') ? ` / ${kind}` : '';
      const sortPart = (state.sort.key === 'none')
        ? ''
        : ` / ã‚½ãƒ¼ãƒˆ: ${state.sort.key === 'date' ? 'æ—¥ä»˜' : state.sort.key === 'artist' ? 'ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ' : 'æ›²å'} ${state.sort.dir === 'asc' ? 'æ˜‡é †' : 'é™é †'}`;

      if (query || kind !== 'all' || state.sort.key !== 'none'){
        return `${rows.length}ä»¶ãƒ’ãƒƒãƒˆï¼ˆå…¨${filteredCount}ä»¶ï¼ç·${state.total}ä»¶${kindPart}${sortPart}ï¼‰ï¼è¡¨ç¤ºä¸Šé™ ${limitLabel}`;
      }
      return `è¡¨ç¤ºä¸­ ${rows.length}ä»¶ï¼ˆç·${state.total}ä»¶ï¼‰ï¼è¡¨ç¤ºä¸Šé™ ${limitLabel}`;
    }

    function renderTable(rows){
      const tableWrap = $('table');
      if (!tableWrap) return;

      const table = document.createElement('table');
      table.className = 'stacked';

      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      const th = document.createElement('th');
      th.textContent = 'ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆï¼æ¥½æ›²æƒ…å ±';
      trh.appendChild(th);
      thead.appendChild(trh);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      const fragRows = document.createDocumentFragment();

      rows.forEach(([artist, title, cText, dText, cUrl, dUrl]) => {
        const note = String(cText || '').trim();
        const cHref = safeHttpUrl(cUrl);
        const dHref = safeHttpUrl(dUrl) || safeHttpUrl(urlFromText(dText));
        const dLabel = formatYmdLabel(dText);

        const trTop = document.createElement('tr');
        trTop.className = 'item-top';
        const tdTop = document.createElement('td');
        tdTop.style.borderBottom = 'none';

        const l1 = document.createElement('div');
        l1.className = 'l1';
        const a1 = document.createElement('span');
        a1.className = 'artist';
        a1.textContent = artist || '';
        const sep = document.createElement('span');
        sep.className = 'sep';
        sep.textContent = '/';
        const t1 = document.createElement('span');
        t1.className = 'title';
        t1.textContent = title || '';
        l1.appendChild(a1);
        l1.appendChild(sep);
        l1.appendChild(t1);
        tdTop.appendChild(l1);

        if (note){
          const noteEl = document.createElement('div');
          noteEl.className = 'muted';
          noteEl.textContent = note;
          tdTop.appendChild(noteEl);
        }

        trTop.appendChild(tdTop);
        fragRows.appendChild(trTop);

        const trOps = document.createElement('tr');
        trOps.className = 'item-ops';
        const tdOps = document.createElement('td');
        tdOps.style.borderTop = 'none';

        const ops = document.createElement('div');
        ops.className = 'ops';

        const aC = createLinkPill(cHref, 'â–¶æ­Œæ ', 'æ­Œæ ç›´ãƒªãƒ³ã‚¯');
        if (aC) ops.appendChild(aC);

        const aD = createLinkPill(
          dHref,
          dLabel ? `å‡ºå…¸ ${dLabel}` : 'å‡ºå…¸å…ƒ',
          dLabel ? `å‡ºå…¸å…ƒ ${dLabel}` : 'å‡ºå…¸å…ƒæƒ…å ±'
        );
        if (aD) ops.appendChild(aD);

        ops.appendChild(createCopyButton(title, artist));

        tdOps.appendChild(ops);
        trOps.appendChild(tdOps);
        fragRows.appendChild(trOps);
      });

      tbody.appendChild(fragRows);
      table.appendChild(tbody);
      tableWrap.replaceChildren(table);
      tableWrap.style.display = 'block';
      const mbl = $('mblist');
      if (mbl) mbl.style.display = 'none';
    }

    function renderMobile(rows){
      const listWrap = $('mblist');
      if (!listWrap) return;

      listWrap.replaceChildren();
      const frag = document.createDocumentFragment();

      rows.forEach(([artist, title, cText, dText, cUrl, dUrl]) => {
        const note = String(cText || '').trim();
        const cHref = safeHttpUrl(cUrl);
        const dHref = safeHttpUrl(dUrl) || safeHttpUrl(urlFromText(dText));
        const dLabel = formatYmdLabel(dText);

        const item = document.createElement('div');
        item.className = 'item';

        const l1 = document.createElement('div');
        l1.className = 'l1';
        const a1 = document.createElement('span');
        a1.className = 'artist';
        a1.textContent = artist || '';
        const sep = document.createElement('span');
        sep.className = 'sep';
        sep.textContent = '/';
        const t1 = document.createElement('span');
        t1.className = 'title';
        t1.textContent = title || '';
        l1.appendChild(a1);
        l1.appendChild(sep);
        l1.appendChild(t1);

        const l2 = document.createElement('div');
        l2.className = 'l2';

        const aC = createLinkPill(cHref, 'â–¶æ­Œæ ', 'æ­Œæ ç›´ãƒªãƒ³ã‚¯');
        if (aC) l2.appendChild(aC);

        const aD = createLinkPill(
          dHref,
          dLabel ? `å‡ºå…¸ ${dLabel}` : 'å‡ºå…¸å…ƒ',
          dLabel ? `å‡ºå…¸å…ƒ ${dLabel}` : 'å‡ºå…¸å…ƒæƒ…å ±'
        );
        if (aD) l2.appendChild(aD);

        l2.appendChild(createCopyButton(title, artist));

        item.appendChild(l1);
        item.appendChild(l2);

        if (note){
          const noteEl = document.createElement('div');
          noteEl.className = 'muted';
          noteEl.textContent = note;
          item.appendChild(noteEl);
        }

        frag.appendChild(item);
      });

      listWrap.replaceChildren(frag);
      listWrap.style.display = 'block';
    }

    function render(){
      clearFallbackFlag();

      const tableWrap = $('table');
      const listWrap = $('mblist');
      const hint = $('hint');

      if (tableWrap) tableWrap.style.display = 'none';
      if (listWrap) listWrap.style.display = 'none';

      const view = buildFilteredSongs(state);

      setStatus(buildStatusText(view));

      if (view.rows.length === 0){
        setTextIfChanged(
          hint,
          (view.query || view.kind !== 'all')
            ? 'è©²å½“ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚'
            : 'æ¤œç´¢çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚'
        );
        return;
      }

      setTextIfChanged(hint, '');

      if (!state.isMobile){
        renderTable(view.rows);
      } else {
        renderMobile(view.rows);
      }
    }

    function requestRender(){
      if (state.renderRaf) return;
      state.renderRaf = requestAnimationFrame(() => {
        state.renderRaf = null;
        render();
      });
    }

    /* ===== é€šä¿¡å‡¦ç† ===== */
    function jsonpOnce(url, onerror, reqId){
      const s = document.createElement('script');
      s.src = url;
      s.async = true;
      s.dataset.jsonp = String(reqId || '');
      s.onerror = () => {
        try{ s.remove(); }catch(e){}
        if (onerror) onerror();
      };
      document.head.appendChild(s);
    }

    function cleanupJsonpScripts(reqId){
      const sel = reqId ? `script[data-jsonp="${reqId}"]` : 'script[data-jsonp]';
      document.querySelectorAll(sel).forEach(el => {
        try{ el.remove(); }catch(e){}
      });
    }

    function fetchRows(limit, attempt = 0){
      const reqId = ++state.lastReqId;
      state.lastFetchLimit = limit;
      clearError();

      logEvent('fetch start', {reqId, limit, attempt});

      clearTimeout(state.shortTimer);
      state.shortTimer = null;
      clearTimeout(state.globalTimer);
      state.globalTimer = null;
      if (state.iframeTimer){
        clearTimeout(state.iframeTimer);
        state.iframeTimer = null;
        state.iframeReqId = null;
      }
      state.usedIframe = false;
      state.pendingHandler = null;
      cleanupJsonpScripts();
      const prev = document.getElementById('gviz-frame');
      if (prev) prev.remove();

      const base = API_URL.replace(/\/macros\/u\/\d+\//, '/macros/');
      const url = `${base}?callback=onGviz&sheet=${encodeURIComponent(SHEET_KEY)}&limit=${Math.min(limit, HARD_LIMIT)}&authuser=0&v=${Date.now()}`;

      setStatus(attempt === 0 ? 'èª­ã¿è¾¼ã¿ä¸­â€¦' : `èª­ã¿è¾¼ã¿ä¸­â€¦ï¼ˆ${attempt}ï¼‰`, {fallback:false});
      showSkeleton();

      let settled = false;

      const fail = (message, detail = '') => {
        if (settled || reqId !== state.lastReqId) return;
        settled = true;

        clearTimeout(state.shortTimer);
        state.shortTimer = null;
        clearTimeout(state.globalTimer);
        state.globalTimer = null;
        if (state.iframeReqId === reqId && state.iframeTimer){
          clearTimeout(state.iframeTimer);
        }
        state.iframeTimer = null;
        state.iframeReqId = null;
        state.usedIframe = false;

        const frame = document.getElementById('gviz-frame');
        if (frame) frame.remove();
        cleanupJsonpScripts(reqId);
        state.pendingHandler = null;

        setStatus(message, {fallback:false});
        clearSkeleton();
        logEvent('fetch failed', {reqId, attempt, message, detail, usedIframe:state.usedIframe});
        showError(message, {retry:true, detail});
      };

      state.pendingHandler = (payload) => {
        clearFallbackFlag();
        if (settled || reqId !== state.lastReqId) return;
        settled = true;

        clearTimeout(state.shortTimer);
        state.shortTimer = null;
        clearTimeout(state.globalTimer);
        state.globalTimer = null;

        try{
          if (payload && payload.ok === false){
            const errMsg = String(payload.error || 'ã‚µãƒ¼ãƒãƒ¼ãŒã‚¨ãƒ©ãƒ¼ã‚’è¿”ã—ã¾ã—ãŸã€‚');
            fail('ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ', errMsg);
            return;
          }
          if (!payload || !Array.isArray(payload.rows)){
            fail('ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆä¸æ­£ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰', 'ãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
            return;
          }

          const rows = (payload.rows || [])
            .map(r => {
              const artist = r.artist || '';
              const title  = r.title  || '';
              const cText  = r.cText  || '';
              const dText  = r.dText  || '';
              const cUrl   = r.cUrl   || '';
              const dUrl   = r.dUrl   || '';

              const row = [artist, title, cText, dText, cUrl, dUrl];
              row.artistLower = normalize(artist);
              row.titleLower  = normalize(title);
              row.dateInt     = parseYmdInt(dText);
              return row;
            })
            .filter(([a,b]) => ((a || '') + (b || '')).trim() !== '');

          state.rows = rows;
          state.total = Number(
            payload.total ?? payload.matched ?? rows.length
          );

          const f = document.getElementById('gviz-frame');
          if (f) f.remove();
          state.usedIframe = false;
          if (state.iframeReqId === reqId && state.iframeTimer){
            clearTimeout(state.iframeTimer);
          }
          state.iframeTimer = null;
          state.iframeReqId = null;

          cleanupJsonpScripts(reqId);
          state.fetchedLimit = Math.max(state.fetchedLimit || 0, state.rows.length);

          clearError();
          setStatus(`èª­ã¿è¾¼ã¿å®Œäº†ï¼š${state.rows.length}ä»¶ï¼ˆå…¨${state.total}ä»¶ï¼‰`, {fallback:false});
          clearSkeleton();
          logEvent('fetch success', {
            reqId,
            rows: state.rows.length,
            total: state.total,
            usedIframe: state.usedIframe
          });
          render();
          state.pendingHandler = null;
        }catch(e){
          console.error(e);
          fail('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ', 'ä¸€æ™‚çš„ãªã‚¨ãƒ©ãƒ¼ã§ã™ã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
        }
      };

      state.shortTimer = setTimeout(() => {
        if (!settled && attempt < MAX_RETRY){
          logEvent('retry fetch (short timer)', {reqId, attemptNext:attempt+1});
          fetchRows(limit, attempt+1);
        }
      }, SHORT_TRY_MS);

      state.globalTimer = setTimeout(() => {
        if (!settled && reqId === state.lastReqId){
          tryIframeFallback(limit, reqId, 'jsonp-timeout', fail);
        }
      }, JSONP_TIMEOUT_MS);

      jsonpOnce(
        url,
        () => {
          if (settled || reqId !== state.lastReqId) return;
          clearTimeout(state.shortTimer);
          state.shortTimer = null;
          clearTimeout(state.globalTimer);
          state.globalTimer = null;
          logEvent('jsonp script load error', {reqId, attempt});
          const started = tryIframeFallback(limit, reqId, 'jsonp-load-error', fail);
          if (!started){
            fail('ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼ï¼‰', 'ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã¾ãŸã¯å…¬é–‹è¨­å®šã‚’ã”ç¢ºèªãã ã•ã„ã€‚');
          }
        },
        reqId
      );
    }

    function tryIframeFallback(limit, reqId, reason, onTimeout){
      if (reqId !== state.lastReqId) return false;
      if ((state.rows && state.rows.length) > 0) return false;
      if (state.usedIframe) return false;

      state.usedIframe = true;
      logEvent('iframe fallback start', {reqId, reason, limit});

      const reasonLabel =
        reason === 'jsonp-timeout' ? 'å¿œç­”å¾…ã¡è¶…é' :
        reason === 'jsonp-load-error' ? 'ã‚¹ã‚¯ãƒªãƒ—ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼' :
        reason;

      setStatus(`åˆ¥ãƒ«ãƒ¼ãƒˆã§å–å¾—ä¸­â€¦ï¼ˆ${reasonLabel}ï¼‰`, {fallback:true});

      const old = document.getElementById('gviz-frame');
      if (old) old.remove();

      const base = API_URL.replace(/\/macros\/u\/\d+\//, '/macros/');
      const urlFrame = `${base}?frame=1&sheet=${encodeURIComponent(SHEET_KEY)}&limit=${Math.min(limit, HARD_LIMIT)}&authuser=0&v=${Date.now()}`;

      const f = document.createElement('iframe');
      f.id = 'gviz-frame';
      f.src = urlFrame;
      f.style.display = 'none';
      f.width = 0;
      f.height = 0;
      f.tabIndex = -1;
      document.body.appendChild(f);

      clearTimeout(state.iframeTimer);
      state.iframeReqId = reqId;
      state.iframeTimer = setTimeout(() => {
        if (state.lastReqId !== reqId) return;
        const st = $('status');
        if (!st || !st.dataset || !st.dataset.fallback) return;
        if ((state.rows && state.rows.length) > 0) return;

        const detail =
          reason === 'jsonp-timeout'
            ? 'JSONP å¿œç­”ãŒãªãã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å…¬é–‹è¨­å®šã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚'
            : reason === 'jsonp-load-error'
              ? 'ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚å…¬é–‹è¨­å®šã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚'
              : 'åˆ¥ãƒ«ãƒ¼ãƒˆã®å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å…¬é–‹è¨­å®šã‚„ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çŠ¶æ…‹ã‚’ã”ç¢ºèªãã ã•ã„ã€‚';

        logEvent('iframe fallback timeout', {reqId, reason, detail});

        if (typeof onTimeout === 'function'){
          onTimeout('å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚', detail);
        }else{
          setStatus('å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼ˆå…¬é–‹è¨­å®š/ãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèªãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†è©¦è¡Œï¼‰', {fallback:false});
          const g = document.getElementById('gviz-frame');
          if (g) g.remove();
          state.usedIframe = false;
          clearSkeleton();
          showError('å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸã€‚å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚', {retry:true, detail});
        }
      }, IFRAME_WATCHDOG_MS);

      return true;
    }

    /* ===== ã‚¤ãƒ™ãƒ³ãƒˆé¡ ===== */
    window.addEventListener('message', (ev) => {
      const d = ev && ev.data;
      if (!d || d.type !== 'gviz') return;
      clearFallbackFlag();
      logEvent('iframe message received', {hasPayload: !!d.payload, reqId: state.iframeReqId});
      if (typeof state.pendingHandler === 'function') state.pendingHandler(d.payload);
    });

    window.addEventListener('offline', () => {
      setStatus('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã™ã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', {fallback:false});
    });

    window.addEventListener('online', () => {
      clearError();
      setStatus('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«å¾©å¸°ã—ã¾ã—ãŸã€‚å†å–å¾—ã—ã¦ã„ã¾ã™â€¦', {fallback:false});
      fetchRows(INITIAL_FETCH);
    });

    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'visible'){
        const st = $('status');
        if (st && st.dataset && st.dataset.fallback && (state.rows && state.rows.length) > 0){
          clearFallbackFlag();
        }
      }
    });

    /* ===== UIã‚¤ãƒ™ãƒ³ãƒˆ ===== */
    const qEl = $('q');
    if (qEl) qEl.addEventListener('input', scheduleSearch);

    const limitEl = $('limit');
    if (limitEl){
      limitEl.addEventListener('change', () => {
        const raw = limitEl.value;
        if (raw === 'all' && (state.fetchedLimit || 0) < (state.total || HARD_LIMIT)){
          setStatus('å…¨ä»¶ã‚’å–å¾—ã—ã¦ã„ã¾ã™â€¦', {fallback:false});
          fetchRows(HARD_LIMIT);
        }else{
          render();
        }
      });
    }

    const kindEl = $('kind');
    if (kindEl){
      kindEl.addEventListener('change', render);
    }

    const refetchEl = $('refetch');
    if (refetchEl){
      refetchEl.addEventListener('click', () => {
        setStatus('æœ€æ–°ã®ãƒ‡ãƒ¼ã‚¿ã‚’å†å–å¾—ã—ã¦ã„ã¾ã™â€¦', {fallback:false});
        fetchRows(state.lastFetchLimit || INITIAL_FETCH);
      });
    }

    function updateSortButtons(){
      const btnLatest = $('sort-latest-toggle');
      const btnTitle  = $('sort-title-toggle');
      const btnArtist = $('sort-artist-toggle');

      const applyButtonState = (btn, label, isActive, arrow) => {
        if (!btn) return;
        setTextIfChanged(btn, `${label}${arrow}`);
        setAriaIfChanged(btn, 'aria-pressed', isActive ? 'true' : 'false');
        btn.classList.toggle('btn-ghost', !isActive);
      };

      const isLatest = state.sort.key === 'date';
      const latestArrow = isLatest ? (state.sort.dir === 'asc' ? 'â†‘' : 'â†“') : 'â†“';
      applyButtonState(btnLatest, 'æœ€æ–°æ›²é †', isLatest, latestArrow);

      const isTitle = state.sort.key === 'title';
      const titleArrow = isTitle ? (state.sort.dir === 'asc' ? 'â†‘' : 'â†“') : 'â†“';
      applyButtonState(btnTitle, 'æ›²åé †', isTitle, titleArrow);

      const isArtist = state.sort.key === 'artist';
      const artistArrow = isArtist ? (state.sort.dir === 'asc' ? 'â†‘' : 'â†“') : 'â†“';
      applyButtonState(btnArtist, 'ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåé †', isArtist, artistArrow);
    }

    function setSort(key, dir){
      state.sort.key = key;
      state.sort.dir = dir;
      updateSortButtons();
      render();
    }

    const btnLatest = $('sort-latest-toggle');
    if (btnLatest){
      btnLatest.addEventListener('click', () => {
        const nextDir = (state.sort.key === 'date' && state.sort.dir === 'desc') ? 'asc' : 'desc';
        setSort('date', nextDir);
      });
    }

    const btnTitle = $('sort-title-toggle');
    if (btnTitle){
      btnTitle.addEventListener('click', () => {
        const nextDir = (state.sort.key === 'title' && state.sort.dir === 'desc') ? 'asc' : 'desc';
        setSort('title', nextDir);
      });
    }

    const btnArtist = $('sort-artist-toggle');
    if (btnArtist){
      btnArtist.addEventListener('click', () => {
        const nextDir = (state.sort.key === 'artist' && state.sort.dir === 'desc') ? 'asc' : 'desc';
        setSort('artist', nextDir);
      });
    }

    function handleMediaChange(ev){
      const next = (ev && ev.matches) != null ? ev.matches : mediaQuery.matches;
      if (state.isMobile === next) return;
      state.isMobile = next;
      requestRender();
    }

    if (mediaQuery.addEventListener){
      mediaQuery.addEventListener('change', handleMediaChange);
    }else if (mediaQuery.addListener){
      mediaQuery.addListener(handleMediaChange);
    }

    window.addEventListener('resize', () => {
      requestRender();
    });

    updateSortButtons();
    console.log('UI layout + sort + fetch debug v20251124');

    // åˆå›ãƒ‡ãƒ¼ã‚¿å–å¾—
    fetchRows(INITIAL_FETCH);
  </script>
</body>
</html>
