<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <meta name="theme-color" content="#ffb744">
  <title>é›²ä¸¹ã‚ãã‚‰æ­Œå”±æ›²DB</title>

  <link rel="dns-prefetch" href="https://script.google.com">
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="dns-prefetch" href="https://script.googleusercontent.com">
  <link rel="preconnect" href="https://script.googleusercontent.com" crossorigin>

  <link rel="icon" href="/uni-ikura-songs-db/favicon.ico" sizes="any">
  <link rel="icon" href="/uni-ikura-songs-db/favicon-32.png" sizes="32x32" type="image/png">
  <link rel="icon" href="/uni-ikura-songs-db/favicon-16.png" sizes="16x16" type="image/png">
  <link rel="apple-touch-icon" href="/uni-ikura-songs-db/apple-touch-icon.png" sizes="180x180">

  <style>
    :root{
      --bg:#ffb744;
      --card:#ffffff;
      --text:#1a1a1a;
      --muted:#6b7280;
      --line:#e5e7eb;
      --thead:#ffe0b5;
      --focus:#3897c9;
      --pill-bg:#f6f7f9;
      --link:#2563eb;
      --control-h:34px;
    }

    *{box-sizing:border-box}

    body{
      background:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      line-height:1.7;
      margin:12px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      padding:14px;
      box-shadow:0 2px 10px rgba(0,0,0,.06);
    }

    .row{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .row .search{
      flex:1 1 auto;
      min-width:0;
    }

    .toolbar{display:none}

    /* â”€â”€ ä¸Šéƒ¨ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆä»¶æ•°ãƒ»å¯¾è±¡ãƒ»ä¸¦ã³æ›¿ãˆï¼‰ã‚’é«˜ã•34pxã§æƒãˆã‚‹ â”€â”€ */
    .limit-wrap,
    .type-wrap,
    .show-sort-btn{
      height:var(--control-h);
    }

    .limit-wrap{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .limit-wrap label{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      line-height:1;
    }
    #limit{
      width:auto;
      min-width:78px;
      height:var(--control-h);
      padding:6px 8px;
      font-size:13px;
      line-height:1.2;
    }

    .type-wrap{
      display:flex;
      align-items:center;
      gap:6px;
    }
    .type-wrap label{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
      line-height:1;
    }
    #kind{
      width:auto;
      min-width:90px;
      height:var(--control-h);
      padding:6px 8px;
      font-size:13px;
      line-height:1.2;
    }

    .dm-wrap{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .dm-select-wrap{flex:7 1 0}
    .dm-select-wrap.is-custom{
      display:flex;
      align-items:center;
      gap:8px;
    }
    .dm-btn-wrap{
      flex:3 1 0;
      display:flex;
    }
    .dm-custom{
      margin-top:8px;
      display:none;
    }
    #dm-select{
      width:100%;
      padding:6px 10px;
      font-size:16px;
      line-height:1.2;
    }
    .dm-select-wrap.is-custom #dm-select{
      width:calc(100% - 3ch);
      flex:1 1 auto;
    }
    .dm-select-wrap.is-custom .dm-custom{
      display:block;
      margin-top:0;
      flex:0 0 auto;
    }
    .btn-full{width:100%}

    input[type="search"],select{
      width:100%;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:12px;
      font-size:16px;
      background:#fff;
      color:#1a1a1a;
      outline:none;
    }
    .dm-custom input{
      width:64px;
      padding:6px 8px;
      border:1px solid var(--line);
      border-radius:10px;
      font-size:15px;
    }
    input[type="search"]:focus,
    input[type="text"]:focus,
    select:focus,
    .btn:focus,
    .btn-pill:focus{
      outline:3px solid var(--focus);
      outline-offset:2px;
    }

    .muted{
      color:var(--muted);
      font-size:13px;
    }

    .btn{
      appearance:none;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      border-radius:10px;
      padding:8px 12px;
      font-size:14px;
      cursor:pointer;
      white-space:nowrap;
    }
    .btn:hover{background:#f9fafb}
    .btn:active{transform:translateY(1px)}

    .toast{
      position:fixed;
      left:50%;
      bottom:16px;
      transform:translateX(-50%);
      background:rgba(17,24,39,.92);
      color:#fff;
      padding:10px 14px;
      border-radius:10px;
      font-size:14px;
      opacity:0;
      transition:opacity .2s ease;
    }
    .toast.show{opacity:1}

    table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      table-layout:fixed;
    }
    th,td{
      border-bottom:1px solid var(--line);
      padding:10px 8px;
      font-size:15px;
      vertical-align:top;
    }
    th{
      position:sticky;
      top:0;
      background:var(--thead);
      z-index:1;
      font-weight:700;
    }

    table.stacked{table-layout:auto}
    table.stacked th,
    table.stacked td{width:auto !important}
    table.stacked thead th{
      width:100% !important;
      white-space:nowrap;
    }
    table.stacked .item-top{
      background:#fff;
      border-bottom:none;
    }
    table.stacked .item-ops{background:#fff}
    table.stacked .item-ops td{border-top:none}
    table.stacked .item-top .l1{
      font-size:16px;
      font-weight:700;
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:flex-start;
    }
    table.stacked .item-top .l1 .sep{opacity:.6}
    table.stacked .item-ops .ops{
      display:flex;
      gap:6px;
      align-items:center;
      justify-content:flex-end;
      flex-wrap:wrap;
      overflow:visible;
      min-width:0;
    }

    /* â”€â”€ æ“ä½œåˆ—ã ã‘å°ã•ã â”€â”€ */
    table.stacked .item-ops .ops .btn-pill,
    table.stacked .item-ops .ops .btn{
      font-size:12px;
      padding:6px 10px;
      border-radius:8px;
      line-height:1.2;
    }

    .btn-pill{
      display:inline-block;
      border:1px solid var(--line);
      background:var(--pill-bg);
      color:var(--link);
      border-radius:10px;
      padding:8px 12px;
      line-height:1.2;
      text-decoration:none;
      white-space:nowrap;
      word-break:keep-all;
      max-width:unset;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .btn-pill:hover{
      background:#eef2f7;
      text-decoration:none;
    }
    .btn-pill:active{transform:translateY(1px)}

    .skeleton{
      height:16px;
      background:#f1f5f9;
      border-radius:6px;
      margin:8px 0;
      animation:pulse 1.2s ease-in-out infinite;
    }
    @keyframes pulse{
      0%{opacity:.6}
      50%{opacity:1}
      100%{opacity:.6}
    }
    @media (prefers-reduced-motion: reduce){
      .skeleton{animation:none}
      .toast{transition:none}
    }

    .mobile-list{display:none}

    @media (max-width:768px){
      table{display:none}
      .mobile-list{display:block;margin-top:10px}
      .item{
        border-bottom:1px solid var(--line);
        padding:12px 2px;
        display:flex;
        flex-direction:column;
        gap:6px;
      }
      .l1{
        font-size:16px;
        line-height:1.6;
        font-weight:700;
        display:flex;
        gap:6px;
        flex-wrap:wrap;
      }
      .l1 .sep{opacity:.6}
      .l2{
        display:flex;
        align-items:center;
        gap:6px;
        justify-content:flex-end;
        flex-wrap:nowrap;
        overflow:hidden;
      }
      .l2 .btn-pill{max-width:40vw}
      .btn{padding:8px 12px;font-size:14px}
      .dm-select-wrap{flex:7 1 0}
      .dm-btn-wrap{flex:3 1 0}

      /* ãƒ¢ãƒã‚¤ãƒ«ã§ã‚‚ä¸¦ã³æ›¿ãˆãƒœã‚¿ãƒ³ã¯é»’ã«ã™ã‚‹ */
      .show-sort-btn,
      .sort-btn{
        color:#000 !important;
      }

      .l2 .btn-pill,
      .l2 .btn{
        font-size:12px;
        padding:6px 10px;
        border-radius:8px;
      }
    }

    .ui .row{
      display:flex;
      gap:8px;
      align-items:center;
      margin-top:8px;
    }
    .ui .row:first-child{margin-top:0}
    .ui .row2 .search{flex:1 1 0;min-width:0}
    .ui .row3 .dm-select-wrap{flex:7 1 0}
    .ui .row3 .dm-btn-wrap{flex:3 1 0}
    .ui .row4 #status{flex:1 1 0}

    .ui .row1 .limit-wrap,
    .ui .row1 .type-wrap{flex:0 0 auto}

    /* â–¼ ä¸¦ã¹æ›¿ãˆUIã®ä¸Šæ›¸ã â–¼ */
    .ui .row1{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:nowrap;
    }

    .ui .row1b{
      display:none;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
    }
    .ui .row1b.is-open{
      display:flex;
    }

    /* ä¸¦ã³æ›¿ãˆãƒœã‚¿ãƒ³ï¼ˆãƒˆã‚°ãƒ«ï¼‰ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’34pxã§å›ºå®šãƒ»é»’ã«å›ºå®š */
    .show-sort-btn{
      min-width:78px;
      height:var(--control-h);
      border:1px solid var(--line);
      background:#fff;
      border-radius:10px;
      padding:6px 10px;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
      color:#000;
      -webkit-appearance:none;
    }

    /* ä¸¦ã¹æ›¿ãˆ3ãƒœã‚¿ãƒ³ï¼ˆæ­Œæ‰‹åé †/æ¥½æ›²é †/æŠ•ç¨¿æ—¥é †ï¼‰ã‚‚é»’ã«å›ºå®š */
    .sort-btn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:10px;
      padding:6px 10px;
      font-size:13px;
      cursor:pointer;
      white-space:nowrap;
      height:var(--control-h);
      display:flex;
      align-items:center;
      color:#000;
      -webkit-appearance:none;
    }
    .sort-btn.is-active{
      border-color:var(--focus);
      background:rgba(56,151,201,.08);
      color:#000;
      font-weight:600;
    }

    .sort-btn:focus,
    .show-sort-btn:focus{
      outline:3px solid var(--focus);
      outline-offset:2px;
    }
    .sort-btn.is-active:focus{
      outline:3px solid var(--focus);
      outline-offset:2px;
    }
  </style>
</head>
<body>

  <div class="card ui">
    <!-- 1åˆ—ç›®ï¼šä»¶æ•° / å¯¾è±¡ / ä¸¦ã³æ›¿ãˆãƒˆã‚°ãƒ« -->
    <div class="row row1">
      <div class="limit-wrap">
        <label for="limit">ä»¶æ•°</label>
        <select id="limit" aria-label="è¡¨ç¤ºä»¶æ•°">
          <option value="20" selected>20ä»¶</option>
          <option value="50">50ä»¶</option>
          <option value="200">200ä»¶</option>
          <option value="all">å…¨ä»¶</option>
        </select>
      </div>

      <div class="type-wrap">
        <label for="kind">å¯¾è±¡</label>
        <select id="kind" aria-label="å¯¾è±¡ãƒ•ã‚£ãƒ«ã‚¿">
          <option value="all" selected>ã™ã¹ã¦</option>
          <option value="æ­Œã£ã¦ã¿ãŸ">æ­Œã£ã¦ã¿ãŸ</option>
          <option value="ã‚·ãƒ§ãƒ¼ãƒˆ">ã‚·ãƒ§ãƒ¼ãƒˆ</option>
        </select>
      </div>

      <button id="show-sort" class="show-sort-btn" type="button">ä¸¦ã³æ›¿ãˆ</button>
    </div>

    <!-- ä¸¦ã¹æ›¿ãˆãƒœã‚¿ãƒ³ç¾¤ -->
    <div class="row row1b" id="sort-panel" aria-label="ä¸¦ã¹æ›¿ãˆ">
      <button type="button" class="sort-btn" data-sort="artist" id="sort-artist">æ­Œæ‰‹åé †â†‘</button>
      <button type="button" class="sort-btn" data-sort="title"  id="sort-title">æ¥½æ›²é †â†‘</button>
      <button type="button" class="sort-btn" data-sort="date"   id="sort-date">æŠ•ç¨¿æ—¥é †â†‘</button>
    </div>

    <!-- 2åˆ—ç›®ï¼šæ¤œç´¢ -->
    <div class="row row2">
      <input class="search" id="q" type="search" placeholder="æ›²åï¼ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã§æ¤œç´¢" autocomplete="off">
    </div>

    <!-- 3åˆ—ç›®ï¼šå¼¾å¹•ã‚³ãƒ”ãƒ¼ -->
    <div class="row row3 dm-wrap" aria-label="å¼¾å¹•ã‚³ãƒ”ãƒ¼">
      <div class="dm-select-wrap">
        <select id="dm-select" title="å¼¾å¹•ã®ç¨®é¡ã‚’é¸æŠ">
          <option value="ğŸ§¡ğŸ¶ğŸ£ğŸ¥‚ğŸ§¡ğŸ¶ğŸ£ğŸ¥‚ğŸ§¡ğŸ¶ğŸ£ğŸ¥‚">ğŸ§¡ğŸ¶ğŸ£ğŸ¥‚â€¦(ğŸ¥‚)</option>
          <option value="ğŸ£ğŸ¶ğŸ§¡âœ¨ğŸ£ğŸ¶ğŸ§¡âœ¨ğŸ£ğŸ¶ğŸ§¡âœ¨">ğŸ£ğŸ¶ğŸ§¡âœ¨â€¦(ğŸ£)</option>
          <option value="ğŸ¶ğŸ§¡ğŸºğŸ¶ğŸ§¡ğŸºğŸ¶ğŸ§¡ğŸºğŸ¶ğŸ§¡ğŸº">ğŸ¶ğŸ§¡ğŸºğŸ¶â€¦(ğŸ¶)</option>
          <option value="ğŸ§ğŸ’«â™¬ğŸ§¡ğŸ§ğŸ’«â™¬ğŸ§¡ğŸ§ğŸ’«â™¬ğŸ§¡">ğŸ§ğŸ’«â™¬ğŸ§¡â€¦(ğŸ§)</option>
          <option value="ğŸ§¡ğŸ¹ğŸ¶ğŸ£ğŸ§¡ğŸ¹ğŸ¶ğŸ£ğŸ§¡ğŸ¹ğŸ¶ğŸ£">ğŸ§¡ğŸ¹ğŸ¶ğŸ£â€¦(ğŸ¹)</option>
          <option value="ğŸµâ˜€ğŸ§¡ï½ğŸµâ˜€ğŸ§¡ï½ğŸµâ˜€ğŸ§¡ï½">ğŸµâ˜€ğŸ§¡ï½â€¦(ğŸµ)</option>
          <option value="ä¸–ç•Œä¸€ğŸŒğŸŒŸâ‹†ê™³ã‚¤ã‚±ãƒœâœ¨ä¸–ç•Œä¸€ğŸŒğŸŒŸâ‹†ê™³ã‚¤ã‚±ãƒœâœ¨ä¸–ç•Œä¸€ğŸŒğŸŒŸâ‹†ê™³ã‚¤ã‚±ãƒœâœ¨">ä¸–ç•Œä¸€ã‚¤ã‚±ãƒœâ€¦(ğŸŒ)</option>
          <option value="âœ©à¿â‹†*ğŸ¼ğŸ‘¶ ï¾ŸÂ·ê’°à¦Œ ï¾Šï¾ï½¯ï¾Œï¾ï½° à»’ê’±Â· ï¾ŸğŸ‘¶ğŸ¼âœ©à¿â‹†*">âœ©à¿â‹†*ğŸ¼ğŸ‘¶â€¦(ğŸ¼)</option>
          <option value="custom">ã‚«ã‚¹ã‚¿ãƒ å¼¾å¹•</option>
        </select>

        <div class="dm-custom" id="dm-custom">
          <input id="dm-custom-input" type="text" aria-label="ã‚«ã‚¹ã‚¿ãƒ å¼¾å¹•å…¥åŠ›" autocomplete="off">
        </div>
      </div>
      <div class="dm-btn-wrap">
        <button id="dm-copy" class="btn btn-full" type="button" title="é¸æŠã—ãŸå¼¾å¹•ã‚’ã‚³ãƒ”ãƒ¼">å¼¾å¹•ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>

    <!-- 4åˆ—ç›®ï¼šã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
    <div class="row row4">
      <div class="muted" id="status" role="status" aria-live="polite">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
    </div>
  </div>

  <!-- çµæœè¡¨ç¤ºã‚«ãƒ¼ãƒ‰ -->
  <div class="card" style="margin-top:12px;">
    <div class="muted" id="hint">æ¤œç´¢çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
    <div id="table" style="display:none;"></div>
    <div id="mblist" class="mobile-list" style="display:none;"></div>
  </div>

  <!-- ãƒˆãƒ¼ã‚¹ãƒˆ -->
  <div id="toast" class="toast" role="status" aria-live="polite">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</div>

  <script>
    /* ===== è¨­å®š ===== */
    const API_URL       = 'https://script.google.com/macros/s/AKfycbxf6Ifxokz6W9w6E1KOwQxapCgpZAR1WE1VPn9MDnMIXLfRuLAqZwx9HyVzMyuC6nITJA/exec';
    const SHEET_KEY     = 'perf';
    const INITIAL_FETCH = 250;
    const HARD_LIMIT    = 500;

    const JSONP_TIMEOUT_MS   = 6500;
    const SHORT_TRY_MS       = 1500;
    const MAX_RETRY          = 2;
    const IFRAME_WATCHDOG_MS = 10000;

    const state = {
      rows: [],
      total: 0,
      fetchedLimit: 0,
      debounce: null,
      lastReqId: 0,
      usedIframe: false,
      pendingHandler: null,
      globalTimer: null,
      shortTimer: null,
      iframeTimer: null,
      iframeReqId: null,
      sort: {
        key: 'artist',  // artist | title | date
        dir: 1,
        panel: false
      }
    };

    /* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
    function $(id){ return document.getElementById(id); }

    function setStatus(text, opts = {}){
      const el = $('status');
      if (!el) return;
      el.textContent = text;
      if (opts.fallback){
        el.dataset.fallback = '1';
      } else {
        delete el.dataset.fallback;
      }
    }

    function clearFallbackFlag(){
      const el = $('status');
      if (el) delete el.dataset.fallback;
    }

    window.onGviz = function(payload){
      clearFallbackFlag();
      if (typeof state.pendingHandler === 'function') state.pendingHandler(payload);
    };

    function normalize(s){
      return (s || '')
        .toString()
        .toLowerCase()
        .replace(/\s+/g, ' ')
        .trim();
    }

    function scheduleSearch(){
      clearTimeout(state.debounce);
      state.debounce = setTimeout(render, 160);
    }

    function showToast(msg){
      const t = $('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 1400);
    }

    async function copyPair(title, artist){
      let text = ((title || '').trim() + ' / ' + (artist || '').trim()).trim();
      try{
        if (navigator.clipboard?.writeText){
          await navigator.clipboard.writeText(text);
        }else{
          const ta = document.createElement('textarea');
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          ta.remove();
        }
        showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼š' + text);
      }catch(e){
        showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    }

    function buildCustomDm(text){
      const custom = text || '';
      if (!custom) return 'ğŸ£ğŸ§¡ğŸ£ğŸ§¡ğŸ£ğŸ§¡';
      return Array.from({length:3},()=>`ğŸ£ğŸ§¡${custom}`).join('');
    }

    (function(){
      const select = $('dm-select');
      const customWrap = $('dm-custom');
      const customInput = $('dm-custom-input');
      const dmSelectWrap = select?.closest('.dm-select-wrap');
      if (!select || !customWrap || !customInput || !dmSelectWrap) return;

      function toggleCustom(){
        const isCustom = select.value === 'custom';
        dmSelectWrap.classList.toggle('is-custom', isCustom);
        if (isCustom) customInput.focus();
      }

      select.addEventListener('change', toggleCustom);
      toggleCustom();
    })();

    $('dm-copy').addEventListener('click', async ()=>{
      const select = $('dm-select');
      const text = (select?.value === 'custom') ? buildCustomDm($('dm-custom-input')?.value || '') : (select?.value || '');
      try{
        if (navigator.clipboard?.writeText){
          await navigator.clipboard.writeText(text);
        }else{
          const ta = document.createElement('textarea');
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          ta.remove();
        }
        showToast('å¼¾å¹•ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
      }catch(e){
        showToast('å¼¾å¹•ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ');
      }
    });

    function urlFromText(s){
      if (!s) return '';
      const m = String(s).match(/https?:\/\/\S+/);
      return m ? m[0].replace(/[)\]\s]+$/, '') : '';
    }

    function formatYmdLabel(s){
      const m = /^(\d{4})(\d{2})(\d{2})/.exec(String(s || ''));
      return m ? `${m[1]}/${m[2]}/${m[3]}` : null;
    }

    function safeHttpUrl(u){
      if (!u) return '';
      try{
        const url = new URL(String(u));
        return (url.protocol === 'http:' || url.protocol === 'https:') ? url.href : '';
      }catch(e){
        return '';
      }
    }

    function showSkeleton(){
      const wrap = $('table');
      wrap.innerHTML = '';
      for (let i=0;i<6;i++){
        const sk = document.createElement('div');
        sk.className = 'skeleton';
        wrap.appendChild(sk);
      }
    }

    function clearSkeleton(){
      $('table').innerHTML = '';
    }

    function getKindValue(){
      const el = $('kind');
      return el ? el.value : 'all';
    }

    // Dåˆ—ã‹ã‚‰æ—¥ä»˜ã‚’æŠœã
    function toSortableDate(dText){
      if (!dText) return 0;
      const digits = String(dText).replace(/\D/g, '');
      if (digits.length < 8) return 0;
      const y = digits.slice(0,4);
      const m = digits.slice(4,6);
      const d = digits.slice(6,8);
      return Number(y + m + d);
    }

    /* ===== æç”» ===== */
    function render(){
      clearFallbackFlag();

      const tableWrap = $('table');
      const listWrap  = $('mblist');
      const hint      = $('hint');

      tableWrap.innerHTML = '';
      listWrap.innerHTML  = '';

      tableWrap.style.display = 'none';
      listWrap.style.display  = 'none';

      const isMobile = window.matchMedia('(max-width: 768px)').matches;

      const q        = normalize($('q').value || '');
      const rawLimit = $('limit').value;
      const kind     = getKindValue();

      const limit = (rawLimit === 'all')
        ? Math.min(HARD_LIMIT, state.total || state.rows.length)
        : Math.min(parseInt(rawLimit,10) || 20, HARD_LIMIT);

      const limitLabel = (rawLimit === 'all') ? 'å…¨ä»¶' : `${limit}ä»¶`;

      let filtered = state.rows;

      // æ¤œç´¢
      if (q){
        filtered = filtered.filter(([artist, title])=>{
          const a = normalize(artist);
          const t = normalize(title);
          return a.includes(q) || t.includes(q);
        });
      }

      // å¯¾è±¡ãƒ•ã‚£ãƒ«ã‚¿
      if (kind !== 'all'){
        filtered = filtered.filter(([, , cText]) => String(cText || '').trim() === kind);
      }

      // ä¸¦ã¹æ›¿ãˆ
      const { key, dir } = state.sort;
      filtered = filtered.slice().sort((r1, r2)=>{
        if (key === 'artist'){
          const v1 = (r1[0] || '').toString();
          const v2 = (r2[0] || '').toString();
          return v1.localeCompare(v2, 'ja') * dir;
        }
        if (key === 'title'){
          const v1 = (r1[1] || '').toString();
          const v2 = (r2[1] || '').toString();
          return v1.localeCompare(v2, 'ja') * dir;
        }
        // date
        let v1 = toSortableDate(r1[3] || '');
        let v2 = toSortableDate(r2[3] || '');
        if (v1 === 0 && r1[5]) v1 = toSortableDate(r1[5]);
        if (v2 === 0 && r2[5]) v2 = toSortableDate(r2[5]);
        return (v1 - v2) * dir;
      });

      const rows = filtered.slice(0, limit);

      if (q || kind !== 'all'){
        setStatus(
          `è¡¨ç¤ºä¸­ ${rows.length}ä»¶ãƒ’ãƒƒãƒˆï¼ˆå¯¾è±¡${filtered.length}ä»¶ï¼${state.total}ä»¶ï¼‰ï¼è¡¨ç¤ºä¸Šé™ ${limitLabel}`
        );
      }else{
        setStatus(
          `è¡¨ç¤ºä¸­ ${rows.length}ä»¶ãƒ’ãƒƒãƒˆï¼ˆå…¨${state.total}ä»¶ï¼‰ï¼è¡¨ç¤ºä¸Šé™ ${limitLabel}`
        );
      }

      if (rows.length === 0){
        hint.textContent = (q || kind !== 'all') ? 'è©²å½“ãªã—' : 'æ¤œç´¢çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚';
        return;
      }
      hint.textContent = '';

      if (!isMobile){
        const table = document.createElement('table');
        table.className = 'stacked';

        const thead = document.createElement('thead');
        const trh   = document.createElement('tr');
        const th    = document.createElement('th');
        th.textContent = 'ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆï¼æ¥½æ›²æƒ…å ±';
        trh.appendChild(th);
        thead.appendChild(trh);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');

        rows.forEach(([artist, title, cText, dText, cUrl, dUrl])=>{
          // ä¸Šæ®µ
          const trTop = document.createElement('tr');
          trTop.className = 'item-top';
          const tdTop = document.createElement('td');
          tdTop.style.borderBottom = 'none';

          const l1 = document.createElement('div');
          l1.className = 'l1';

          const a1 = document.createElement('span');
          a1.className = 'artist';
          a1.textContent = artist || '';

          const sep = document.createElement('span');
          sep.className = 'sep';
          sep.textContent = '/';

          const t1 = document.createElement('span');
          t1.className = 'title';
          t1.textContent = title || '';

          l1.appendChild(a1);
          l1.appendChild(sep);
          l1.appendChild(t1);

          tdTop.appendChild(l1);
          trTop.appendChild(tdTop);
          tbody.appendChild(trTop);

          // ä¸‹æ®µ
          const trOps = document.createElement('tr');
          trOps.className = 'item-ops';
          const tdOps = document.createElement('td');
          tdOps.style.borderTop = 'none';

          const ops = document.createElement('div');
          ops.className = 'ops';

          const cHref = safeHttpUrl(cUrl) || safeHttpUrl(urlFromText(cText));
          if (cHref){
            const aC = document.createElement('a');
            aC.href = cHref;
            aC.target = '_blank';
            aC.rel = 'noopener noreferrer';
            aC.className = 'btn-pill';
            aC.title = cText || 'ãƒªãƒ³ã‚¯';
            aC.textContent = cText || 'ãƒªãƒ³ã‚¯';
            ops.appendChild(aC);
          }

          const dHref  = safeHttpUrl(dUrl) || safeHttpUrl(urlFromText(dText));
          const dLabel = formatYmdLabel(dText);
          if (dHref){
            const aD = document.createElement('a');
            aD.href   = dHref;
            aD.target = '_blank';
            aD.rel    = 'noopener noreferrer';
            aD.className = 'btn-pill';
            aD.title = dLabel ? `å‰å› ${dLabel}` : 'å‰å›';
            aD.textContent = dLabel ? `â–¶å‰å›${dLabel}` : 'â–¶å‰å›';
            ops.appendChild(aD);
          }

          const btn = document.createElement('button');
          btn.className = 'btn';
          btn.textContent = 'ã‚³ãƒ”ãƒ¼';
          btn.addEventListener('click', ()=>copyPair(title, artist));
          ops.appendChild(btn);

          tdOps.appendChild(ops);
          trOps.appendChild(tdOps);
          tbody.appendChild(trOps);
        });

        table.appendChild(tbody);
        tableWrap.appendChild(table);
        tableWrap.style.display = 'block';
        $('mblist').style.display = 'none';
      }else{
        rows.forEach(([artist, title, cText, dText, cUrl, dUrl])=>{
          const item = document.createElement('div');
          item.className = 'item';

          const l1 = document.createElement('div');
          l1.className = 'l1';

          const a1 = document.createElement('span');
          a1.className = 'artist';
          a1.textContent = artist || '';

          const sep = document.createElement('span');
          sep.className = 'sep';
          sep.textContent = '/';

          const t1 = document.createElement('span');
          t1.className = 'title';
          t1.textContent = title || '';

          l1.appendChild(a1);
          l1.appendChild(sep);
          l1.appendChild(t1);

          const l2 = document.createElement('div');
          l2.className = 'l2';

          const cHref = safeHttpUrl(cUrl) || safeHttpUrl(urlFromText(cText));
          if (cHref){
            const aC = document.createElement('a');
            aC.href = cHref;
            aC.target = '_blank';
            aC.rel = 'noopener noreferrer';
            aC.className = 'btn-pill';
            aC.title = cText || 'ãƒªãƒ³ã‚¯';
            aC.textContent = cText || 'ãƒªãƒ³ã‚¯';
            l2.appendChild(aC);
          }

          const dHref  = safeHttpUrl(dUrl) || safeHttpUrl(urlFromText(dText));
          const dLabel = formatYmdLabel(dText);
          if (dHref){
            const aD = document.createElement('a');
            aD.href = dHref;
            aD.target = '_blank';
            aD.rel = 'noopener noreferrer';
            aD.className = 'btn-pill';
            aD.title = dLabel ? `å‰å› ${dLabel}` : 'å‰å›';
            aD.textContent = dLabel ? `â–¶å‰å›${dLabel}` : 'â–¶å‰å›';
            l2.appendChild(aD);
          }

          const btn = document.createElement('button');
          btn.className = 'btn';
          btn.textContent = 'ã‚³ãƒ”ãƒ¼';
          btn.addEventListener('click', ()=>copyPair(title, artist));
          l2.appendChild(btn);

          item.appendChild(l1);
          item.appendChild(l2);
          $('mblist').appendChild(item);
        });

        $('mblist').style.display='block';
      }
    }

    /* ===== JSONP ã¾ã‚ã‚Š ===== */
    function jsonpOnce(url, onerror, reqId){
      const s = document.createElement('script');
      s.src = url;
      s.async = true;
      s.dataset.jsonp = String(reqId || '');
      s.onerror = ()=>{
        try{ s.remove(); }catch(e){}
        if (onerror) onerror();
      };
      document.head.appendChild(s);
    }

    function cleanupJsonpScripts(reqId){
      const sel = reqId ? `script[data-jsonp="${reqId}"]` : 'script[data-jsonp]';
      document.querySelectorAll(sel).forEach(el=>{
        try{ el.remove(); }catch(e){}
      });
    }

    function fetchRows(limit, attempt = 0){
      const reqId = ++state.lastReqId;

      // æ—¢å­˜iframeã®æƒé™¤
      if (state.iframeTimer){
        clearTimeout(state.iframeTimer);
        state.iframeTimer = null;
        state.iframeReqId = null;
      }
      const prev = document.getElementById('gviz-frame');
      if (prev) prev.remove();

      const base = API_URL.replace(/\/macros\/u\/\d+\//, '/macros/');
      const url  = `${base}?callback=onGviz&sheet=${encodeURIComponent(SHEET_KEY)}&limit=${Math.min(limit, HARD_LIMIT)}&authuser=0&v=${Date.now()}`;

      setStatus(attempt === 0 ? 'èª­ã¿è¾¼ã¿ä¸­â€¦' : `èª­ã¿è¾¼ã¿ä¸­â€¦ï¼ˆ${attempt}ï¼‰`);
      showSkeleton();

      let settled = false;

      state.pendingHandler = (payload)=>{
        clearFallbackFlag();
        if (settled) return;
        if (reqId !== state.lastReqId) return;
        settled = true;

        clearTimeout(state.shortTimer);
        clearTimeout(state.globalTimer);

        try{
          if (!payload || !Array.isArray(payload.rows)){
            setStatus('ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆä¸æ­£ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰');
            cleanupJsonpScripts(reqId);
            clearSkeleton();
            return;
          }

          const rows = (payload.rows || [])
            .map(r => [
              r.artist || '',
              r.title  || '',
              r.cText  || '',
              r.dText  || '',
              r.cUrl   || '',
              r.dUrl   || ''
            ])
            .filter(([a, b]) => ((a || '') + (b || '')).trim() !== '');

          state.rows  = rows;
          state.total = Number(
            (payload.total ?? null) != null
              ? payload.total
              : (payload.matched ?? rows.length)
          );

          const f = document.getElementById('gviz-frame');
          if (f) f.remove();
          state.usedIframe = false;

          if (state.iframeReqId === reqId && state.iframeTimer){
            clearTimeout(state.iframeTimer);
          }
          state.iframeTimer = null;
          state.iframeReqId = null;

          cleanupJsonpScripts(reqId);
          state.fetchedLimit = Math.max(state.fetchedLimit || 0, state.rows.length);

          setStatus(`èª­ã¿è¾¼ã¿å®Œäº†ï¼š${state.rows.length}ä»¶ï¼ˆå…¨${state.total}ä»¶ï¼‰`);
          clearSkeleton();
          render();
        }catch(e){
          console.error(e);
          setStatus('èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
          cleanupJsonpScripts(reqId);
          clearSkeleton();
        }
      };

      // çŸ­æ™‚é–“ãƒªãƒˆãƒ©ã‚¤
      state.shortTimer = setTimeout(()=>{
        if (!settled && attempt < MAX_RETRY){
          fetchRows(limit, attempt + 1);
        }
      }, SHORT_TRY_MS);

      // å…¨ä½“ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ â†’ iframe
      state.globalTimer = setTimeout(()=>{
        if (!settled && reqId === state.lastReqId){
          tryIframeFallback(limit, reqId, 'jsonp-timeout');
        }
      }, JSONP_TIMEOUT_MS);

      jsonpOnce(url, ()=>{}, reqId);
    }

    function tryIframeFallback(limit, reqId, reason){
      if (reqId !== state.lastReqId) return;
      if ((state.rows && state.rows.length) > 0) return;
      if (state.usedIframe) return;
      state.usedIframe = true;

      setStatus(`åˆ¥ãƒ«ãƒ¼ãƒˆã§å–å¾—ä¸­â€¦ï¼ˆ${reason}ï¼‰`, {fallback:true});

      const old = document.getElementById('gviz-frame');
      if (old) old.remove();

      const base = API_URL.replace(/\/macros\/u\/\d+\//, '/macros/');
      const urlFrame = `${base}?frame=1&sheet=${encodeURIComponent(SHEET_KEY)}&limit=${Math.min(limit, HARD_LIMIT)}&authuser=0&v=${Date.now()}`;

      const f = document.createElement('iframe');
      f.id  = 'gviz-frame';
      f.src = urlFrame;
      f.style.display = 'none';
      f.width  = 0;
      f.height = 0;
      f.tabIndex = -1;
      document.body.appendChild(f);

      clearTimeout(state.iframeTimer);
      state.iframeReqId = reqId;
      state.iframeTimer = setTimeout(()=>{
        if (state.lastReqId !== reqId) return;
        if (!$('status')?.dataset?.fallback) return;
        if ((state.rows && state.rows.length) > 0) return;

        setStatus('å–å¾—ãŒã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸï¼ˆå…¬é–‹è¨­å®š/ãƒ‡ãƒ—ãƒ­ã‚¤ç¢ºèªãƒ»ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å†è©¦è¡Œï¼‰');
        const g = document.getElementById('gviz-frame');
        if (g) g.remove();
        state.usedIframe = false;
        clearSkeleton();
      }, IFRAME_WATCHDOG_MS);
    }

    /* ===== ã‚¤ãƒ™ãƒ³ãƒˆ ===== */
    window.addEventListener('message', (ev)=>{
      const d = ev?.data;
      if (!d || d.type !== 'gviz') return;
      clearFallbackFlag();
      if (typeof state.pendingHandler === 'function') state.pendingHandler(d.payload);
    });

    window.addEventListener('offline', ()=>{
      setStatus('ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã§ã™ã€‚æ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
    });

    window.addEventListener('online', ()=>{
      setStatus('ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã«å¾©å¸°ã—ã¾ã—ãŸã€‚å†å–å¾—ã—ã¦ã„ã¾ã™â€¦');
      fetchRows(INITIAL_FETCH);
    });

    document.addEventListener('visibilitychange', ()=>{
      if (document.visibilityState === 'visible'){
        if ($('status')?.dataset?.fallback && (state.rows && state.rows.length) > 0){
          clearFallbackFlag();
        }
      }
    });

    /* ===== åˆæœŸåŒ– ===== */
    fetchRows(INITIAL_FETCH);

    $('q').addEventListener('input', scheduleSearch);

    $('limit').addEventListener('change', ()=>{
      const raw = $('limit').value;
      if (raw === 'all' && (state.fetchedLimit || 0) < (state.total || HARD_LIMIT)){
        setStatus('å…¨ä»¶ã‚’å–å¾—ã—ã¦ã„ã¾ã™â€¦');
        fetchRows(HARD_LIMIT);
      }else{
        render();
      }
    });

    (function(){
      const el = $('kind');
      if (el) el.addEventListener('change', render);
    })();

    (function(){
      const btn   = $('show-sort');
      const panel = $('sort-panel');
      if (!btn || !panel) return;
      btn.addEventListener('click', ()=>{
        state.sort.panel = !state.sort.panel;
        if (state.sort.panel){
          panel.classList.add('is-open');
          btn.textContent = 'éè¡¨ç¤º';
        }else{
          panel.classList.remove('is-open');
          btn.textContent = 'ä¸¦ã³æ›¿ãˆ';
        }
      });
    })();

    (function(){
      const btnArtist = $('sort-artist');
      const btnTitle  = $('sort-title');
      const btnDate   = $('sort-date');
      if (!btnArtist || !btnTitle || !btnDate) return;

      function updateSortButtons(){
        const { key, dir } = state.sort;
        const m = { artist: btnArtist, title: btnTitle, date: btnDate };

        Object.keys(m).forEach(k=>{
          const b = m[k];
          if (k === key){
            b.classList.add('is-active');
            if (k === 'artist') b.textContent = dir === 1 ? 'æ­Œæ‰‹åé †â†‘' : 'æ­Œæ‰‹åé †â†“';
            if (k === 'title')  b.textContent = dir === 1 ? 'æ¥½æ›²é †â†‘' : 'æ¥½æ›²é †â†“';
            if (k === 'date')   b.textContent = dir === 1 ? 'æŠ•ç¨¿æ—¥é †â†‘' : 'æŠ•ç¨¿æ—¥é †â†“';
          }else{
            b.classList.remove('is-active');
            if (k === 'artist') b.textContent = 'æ­Œæ‰‹åé †â†‘';
            if (k === 'title')  b.textContent = 'æ¥½æ›²é †â†‘';
            if (k === 'date')   b.textContent = 'æŠ•ç¨¿æ—¥é †â†‘';
          }
        });
      }

      function toggleSort(targetKey){
        if (state.sort.key === targetKey){
          state.sort.dir = state.sort.dir * -1;
        } else {
          state.sort.key = targetKey;
          state.sort.dir = 1;
        }
        updateSortButtons();
        render();
      }

      btnArtist.addEventListener('click', ()=>toggleSort('artist'));
      btnTitle.addEventListener('click',  ()=>toggleSort('title'));
      btnDate.addEventListener('click',   ()=>toggleSort('date'));

      updateSortButtons();
    })();

    const mq = window.matchMedia('(max-width: 768px)');
    mq.addEventListener?.('change', render);
    window.addEventListener('resize', render);

    console.log('UI layout fixed v20251023-2 + 34px-controls + black-sort');
  </script>
</body>
</html>
