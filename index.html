<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
  <meta name="theme-color" content="#ffb744">
  <title>é›²ä¸¹ã‚ãã‚‰æ­Œå”±æ›²DB</title>

  <!-- æ¥ç¶šã®å…ˆè¡Œç¢ºç«‹ã§åˆå›ã®å¾…ã¡æ™‚é–“ã‚’çŸ­ç¸® -->
  <link rel="preconnect" href="https://script.google.com" crossorigin>
  <link rel="dns-prefetch" href="https://script.google.com">

  <style>
    :root{
      --bg:#ffb744; --card:#ffffff; --text:#1a1a1a; --muted:#6b7280; --line:#e5e7eb;
      --thead:#ffe0b5; --focus:#3897c9; --chip-bg:#f3f4f6; --chip-text:#111827;
      --link:#2563eb;
    }
    *{box-sizing:border-box}
    body{background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;line-height:1.7;margin:12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 2px 10px rgba(0,0,0,.06)}

    /* ====== ãƒ˜ãƒƒãƒ€ãƒ¼ ====== */
    .row{display:flex;gap:8px;align-items:center}
    .row .search{flex:1 1 auto;min-width:0}

    .toolbar{
      display:flex;align-items:center;justify-content:space-between;
      gap:8px;margin-top:8px;flex-wrap:wrap;
    }
    .limit-wrap{display:flex;align-items:center;gap:6px}
    .limit-wrap label,
    .dm-group label{font-size:12px;color:var(--muted);white-space:nowrap}
    #limit{width:auto;min-width:68px;padding:6px 8px;font-size:13px;line-height:1.2}

    .dm-group{display:flex;align-items:center;gap:6px}
    #dm-select{width:auto;min-width:84px;padding:6px 8px;font-size:14px;line-height:1.2}
    .dm-group .btn{padding:6px 10px;font-size:13px;white-space:nowrap}

    input[type="search"],select{width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;font-size:15px;background:#fff;color:var(--text);outline:none}
    input[type="search"]:focus,select:focus,.btn:focus,.btn-pill:focus{outline:3px solid var(--focus);outline-offset:2px}

    .muted{color:var(--muted);font-size:13px}
    .btn{appearance:none;border:1px solid var(--line);background:#fff;color:var(--text);border-radius:10px;padding:8px 12px;font-size:14px;cursor:pointer}
    .btn:hover{background:#f9fafb}.btn:active{transform:translateY(1px)}

    .toast{position:fixed;left:50%;bottom:16px;transform:translateX(-50%);background:rgba(17,24,39,.92);color:#fff;padding:10px 14px;border-radius:10px;font-size:14px;opacity:0;transition:opacity .2s ease}
    .toast.show{opacity:1}

    table{width:100%;border-collapse:collapse;margin-top:10px;table-layout:fixed}
    th,td{border-bottom:1px solid var(--line);padding:10px 8px;font-size:15px;vertical-align:top}
    th{position:sticky;top:0;background:var(--thead);z-index:1;font-weight:700}
    th:nth-child(1),td:nth-child(1){width:30%} th:nth-child(2),td:nth-child(2){width:50%} th:nth-child(3),td:nth-child(3){width:20%}

    .ops{display:flex;align-items:center;justify-content:flex-end;gap:8px;flex-wrap:wrap}

    @media (max-width:768px){
      table{display:none}
      .mobile-list{display:block;margin-top:10px}
      .item{border-bottom:1px solid var(--line);padding:12px 2px;display:flex;flex-direction:column;gap:6px}
      .l1{font-size:16px;line-height:1.6;font-weight:700;display:flex;gap:6px;flex-wrap:wrap}
      .l1 .sep{opacity:.6}
      .l2{display:flex;align-items:center;gap:8px;justify-content:flex-end;flex-wrap:wrap}
      .btn{padding:8px 12px;font-size:14px}
    }

    /* pillï¼ˆå›²ã¿ï¼‰ */
    .btn-pill{
      display:inline-block;border:1px solid var(--line);background:#fff;color:var(--text);
      border-radius:10px;padding:8px 12px;font-size:14px;line-height:1.2;text-decoration:none;
      white-space:nowrap;max-width:320px;overflow:hidden;text-overflow:ellipsis
    }
    .btn-pill:hover{ text-decoration:none }

    /* æ“ä½œåˆ—ã®ãƒ•ã‚©ãƒ³ãƒˆã‚’1ptå°ã•ãï¼ˆC/D/ã‚³ãƒ”ãƒ¼ï¼‰ */
    .ops .btn-pill{font-size:13px}
    .ops .btn{font-size:13px}

    /* C/Dãƒªãƒ³ã‚¯ï¼ˆa.btn-pillï¼‰ï¼šé’æ–‡å­—ï¼‹æ·¡ã„ç°è‰²ã®ãƒ•ãƒ©ãƒƒãƒˆèƒŒæ™¯ */
    a.btn-pill{
      color:var(--link);
      background-color:var(--chip-bg);
      border-color:var(--line);
    }
    a.btn-pill:visited{color:var(--link)}
    a.btn-pill:hover{text-decoration:underline}
  </style>
</head>
<body>

  <!-- æ¤œç´¢ã‚«ãƒ¼ãƒ‰ -->
  <div class="card">
    <div class="row">
      <input class="search" id="q" type="search" placeholder="æ›²åï¼ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆåã§æ¤œç´¢ï¼ˆä¾‹ï¼šç¾¤é’æ—¥å’Œï¼æ¤åæ—æªï¼‰" autocomplete="off">
    </div>

    <div class="toolbar">
      <div class="limit-wrap">
        <label for="limit">ä»¶æ•°</label>
        <select id="limit" aria-label="è¡¨ç¤ºä»¶æ•°">
          <option value="20" selected>20ä»¶</option>
          <option value="50">50ä»¶</option>
          <option value="200">200ä»¶</option>
          <option value="all">å…¨ä»¶</option>
        </select>
      </div>

      <div class="dm-group" aria-label="å¼¾å¹•ã‚³ãƒ”ãƒ¼">
        <label for="dm-select">å¼¾å¹•</label>
        <select id="dm-select" title="å¼¾å¹•ã‚’é¸æŠ">
          <option value="ğŸ£ğŸ§¡ğŸ£ğŸ§¡ğŸ£ğŸ§¡">ğŸ£ğŸ§¡ğŸ£</option>
          <option value="ğŸ£ğŸ§¡ğŸ¶ğŸ£ğŸ§¡ğŸ¶">ğŸ£ğŸ§¡ğŸ¶</option>
        </select>
        <button id="dm-copy" class="btn" type="button" title="é¸æŠã—ãŸå¼¾å¹•ã‚’ã‚³ãƒ”ãƒ¼">ã‚³ãƒ”ãƒ¼</button>
      </div>
    </div>

    <div class="muted" id="status">èª­ã¿è¾¼ã¿ä¸­â€¦</div>
  </div>

  <!-- çµæœ -->
  <div class="card" style="margin-top:12px;">
    <div class="muted" id="hint">æ¤œç´¢çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
    <div id="table"></div>
    <div id="mblist" class="mobile-list" style="display:none;"></div>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ</div>

  <script>
    /* ===== è¨­å®š ===== */
    const API_URL = 'https://script.google.com/macros/s/AKfycbyEf2jDL40t1j2KgAwhwehw2RVTDQq_aYYtfbFWYXcSBL__TgNSn3G9gK_L4BFDLVVDng/exec';
    const HARD_LIMIT = 20000;          // å…¨ä»¶ã®ä¸Šé™ï¼ˆä¿é™ºï¼‰
    const FIRST_FETCH_LIMIT = 50;      // èµ·å‹•ç›´å¾Œã®è»½é‡ãƒ•ã‚§ãƒƒãƒä»¶æ•°
    const CACHE_KEY = 'perfCache_v1';  // localStorage ã‚­ãƒ¼ï¼ˆã‚¹ã‚­ãƒ¼ãƒå¤‰æ›´æ™‚ã¯vã‚’ä¸Šã’ã‚‹ï¼‰
    const CACHE_TTL_MS = 24*60*60*1000;// 24æ™‚é–“

    let activeToken = 0;               // JSONPãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æœ€æ–°åˆ¤å®šãƒˆãƒ¼ã‚¯ãƒ³
    const state = { rows: [], debounce: null };

    /* ===== JSONP å¿œç­”ã‚’æ¨™æº–å‡¦ç† ===== */
    function onGviz(payload) {
      try {
        if (!payload || !payload.ok || !Array.isArray(payload.rows)) {
          document.getElementById('status').textContent = 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆä¸æ­£ãªãƒ¬ã‚¹ãƒãƒ³ã‚¹ï¼‰';
          return;
        }
        const rows = payload.rows
          .map(r => [ r.artist||'', r.title||'', r.cText||'', r.dText||'', r.cUrl||'', r.dUrl||'' ])
          .filter(([a,b]) => ((a||'')+(b||'')).trim() !== '');
        state.rows = rows;
        document.getElementById('status').textContent = `èª­ã¿è¾¼ã¿å®Œäº†ï¼š${rows.length}ä»¶`;
        render();
      } catch (e) {
        document.getElementById('status').textContent = 'èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ';
        console.error(e);
      }
    }
    window.onGviz = onGviz; // å¿µã®ãŸã‚æ®‹ã™ï¼ˆäº’æ›æ€§ï¼‰

    /* ===== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
    function normalize(s){ return (s||'').toString().toLowerCase().replace(/\s+/g,' ').trim(); }
    function scheduleSearch(){ clearTimeout(state.debounce); state.debounce = setTimeout(render, 200); }
    function $(id){ return document.getElementById(id); }

    function showToast(msg){ const t=$('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'),1400); }

    async function copyPair(title, artist){
      const text = `${(title||'').trim()} / ${(artist||'').trim()}`.trim();
      try{
        if(navigator.clipboard?.writeText) await navigator.clipboard.writeText(text);
        else { const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); }
        showToast('ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼š' + text);
      }catch{ showToast('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      const dmBtn = $('dm-copy');
      if(dmBtn){
        dmBtn.addEventListener('click', async ()=>{
          const text = $('dm-select').value || '';
          try{
            if(navigator.clipboard?.writeText) await navigator.clipboard.writeText(text);
            else { const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); }
            showToast('å¼¾å¹•ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
          }catch{ showToast('å¼¾å¹•ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ'); }
        });
      }
    });

    function urlFromText(s){
      if(!s) return '';
      const m = String(s).match(/https?:\/\/\S+/);
      return m ? m[0].replace(/[)\]\s]+$/, '') : '';
    }
    function formatYmdLabel(s){
      const m = /^(\d{4})(\d{2})(\d{2})/.exec(String(s||''));
      return m ? `${m[1]}/${m[2]}/${m[3]}` : null;
    }

    /* ====== é«˜é€ŸåŒ– 1ï¼šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§å³æç”» ====== */
    (function bootWithCache(){
      try{
        const raw = localStorage.getItem(CACHE_KEY);
        if(!raw) return;
        const {rows, ts} = JSON.parse(raw);
        if(!rows || !Array.isArray(rows)) return;
        state.rows = rows;
        $('status').textContent = `ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰è¡¨ç¤ºï¼š${rows.length}ä»¶` + ((Date.now() - (ts||0) > CACHE_TTL_MS)?'ï¼ˆæ›´æ–°ä¸­â€¦ï¼‰':'');
        render();
      }catch(_){}
    })();

    /* ====== é«˜é€ŸåŒ– 2ï¼šJSONPï¼ˆãƒˆãƒ¼ã‚¯ãƒ³åˆ¶å¾¡ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°ï¼‰ ====== */
    function loadJsonp(limit, cbBaseName){
      const token = ++activeToken;
      const callback = `${cbBaseName}_${token}`;
      window[callback] = function(payload){
        if(token !== activeToken) return;          // å¤ã„å¿œç­”ã¯ç„¡è¦–
        try{
          onGviz(payload);                          // æ¨™æº–å‡¦ç†
          if(payload && payload.ok && Array.isArray(payload.rows)){
            const rows = payload.rows
              .map(r => [ r.artist||'', r.title||'', r.cText||'', r.dText||'', r.cUrl||'', r.dUrl||'' ])
              .filter(([a,b]) => ((a||'')+(b||'')).trim() !== '');
            localStorage.setItem(CACHE_KEY, JSON.stringify({ rows, ts: Date.now() }));
          }
        }finally{
          try{ delete window[callback]; }catch(_){}
        }
      };
      const s = document.createElement('script');
      s.src = `${API_URL}?callback=${callback}&limit=${encodeURIComponent(limit)}&v=${Date.now()}`;
      s.onerror = ()=>{ $('status').textContent = 'ãƒ‡ãƒ¼ã‚¿å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯/ãƒ–ãƒ­ãƒƒã‚¯ï¼‰'; };
      document.head.appendChild(s);
    }

    /* ====== é«˜é€ŸåŒ– 3ï¼šäºŒæ®µéšãƒ­ãƒ¼ãƒ‰ ======
       1) èµ·å‹•ç›´å¾Œã¯ FIRST_FETCH_LIMIT ä»¶ã®ã¿ï¼ˆè»½é‡ï¼‰ã§å³æç”»
       2) 1ç§’å¾Œã«å…¨ä»¶ï¼ˆHARD_LIMITï¼‰ã‚’ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§å–å¾—â†’ä¸Šæ›¸ãæç”»ï¼†ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ›´æ–°
    */
    (function fastBoot(){
      loadJsonp(FIRST_FETCH_LIMIT, 'onGviz');      // è»½é‡ãƒ•ã‚§ãƒƒãƒ
      setTimeout(()=> loadJsonp(HARD_LIMIT, 'onGviz'), 1000);  // å…¨é‡ãƒ•ã‚§ãƒƒãƒ
    })();

    /* ====== æç”»ï¼ˆDocumentFragment ã§å¡Šå·®ã—è¾¼ã¿ï¼‰ ====== */
    function render(){
      const tableWrap = $('table'); tableWrap.innerHTML = '';
      const listWrap  = $('mblist'); listWrap.innerHTML = '';
      const hint = $('hint');

      const q = normalize($('q').value || '');
      const raw = $('limit').value;
      const limit = raw === 'all' ? Math.min(HARD_LIMIT, state.rows.length)
                                  : Math.min(parseInt(raw,10)||20, HARD_LIMIT);
      const limitLabel = raw === 'all' ? 'å…¨ä»¶' : `${limit}ä»¶`;

      let filtered = state.rows;
      if (q) {
        filtered = filtered.filter(([artist, title]) => {
          const a = normalize(artist), t = normalize(title);
          return a.includes(q) || t.includes(q);
        });
      }
      const rows = filtered.slice(0, limit);

      $('status').textContent = q
        ? `${rows.length}ä»¶ãƒ’ãƒƒãƒˆï¼ˆå…¨${filtered.length}ä»¶ï¼‰ï¼è¡¨ç¤ºä¸Šé™ ${limitLabel}`
        : `è¡¨ç¤ºä¸­ ${rows.length}ä»¶ï¼ˆå…¨${state.rows.length}ä»¶ï¼‰ï¼è¡¨ç¤ºä¸Šé™ ${limitLabel}`;

      if (rows.length === 0) { hint.textContent = q ? 'è©²å½“ãªã—' : 'æ¤œç´¢çµæœãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚'; return; }
      hint.textContent = '';

      // ==== PCãƒ†ãƒ¼ãƒ–ãƒ« ====
      const table = document.createElement('table');
      const thead = document.createElement('thead');
      const trh = document.createElement('tr');
      ['ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆå','æ›²å','æ“ä½œ'].forEach(h=>{
        const th=document.createElement('th'); th.textContent=h; trh.appendChild(th);
      });
      thead.appendChild(trh); table.appendChild(thead);

      const tbody = document.createElement('tbody');
      const tfrag = document.createDocumentFragment();

      for(const [artist, title, cText, dText, cUrl, dUrl] of rows){
        const tr=document.createElement('tr');

        let td=document.createElement('td'); td.textContent=artist||''; tr.appendChild(td);
        td=document.createElement('td'); td.textContent=title||''; tr.appendChild(td);

        const tdOps=document.createElement('td'); const ops=document.createElement('div'); ops.className='ops';

        const cHref = cUrl || urlFromText(cText);
        if (cHref) {
          const aC=document.createElement('a');
          aC.href=cHref; aC.target='_blank'; aC.rel='noopener';
          aC.className='btn-pill';
          aC.title=cText||'ãƒªãƒ³ã‚¯';
          aC.textContent=cText||'ãƒªãƒ³ã‚¯';
          ops.appendChild(aC);
        }

        const dHref = dUrl || urlFromText(dText);
        const dLabel = formatYmdLabel(dText);
        if (dHref) {
          const aD=document.createElement('a');
          aD.href=dHref; aD.target='_blank'; aD.rel='noopener';
          aD.className='btn-pill';
          aD.title=dLabel ? `å‰å› ${dLabel}` : 'å‰å›';
          aD.textContent=dLabel ? `â–¶å‰å›${dLabel}` : 'â–¶å‰å›';
          ops.appendChild(aD);
        }

        const btn=document.createElement('button'); btn.className='btn'; btn.textContent='ã‚³ãƒ”ãƒ¼';
        btn.addEventListener('click',()=>copyPair(title,artist));
        ops.appendChild(btn);

        tdOps.appendChild(ops); tr.appendChild(tdOps);
        tfrag.appendChild(tr);
      }
      tbody.appendChild(tfrag);
      table.appendChild(tbody);
      tableWrap.appendChild(table);

      // ==== ãƒ¢ãƒã‚¤ãƒ«2è¡Œã‚«ãƒ¼ãƒ‰ ====
      const lfrag = document.createDocumentFragment();
      for(const [artist, title, cText, dText, cUrl, dUrl] of rows){
        const item=document.createElement('div'); item.className='item';

        const l1=document.createElement('div'); l1.className='l1';
        const a1=document.createElement('span'); a1.className='artist'; a1.textContent=artist||'';
        const sep=document.createElement('span'); sep.className='sep'; sep.textContent='/';
        const t1=document.createElement('span'); t1.className='title'; t1.textContent=title||'';
        l1.appendChild(a1); l1.appendChild(sep); l1.appendChild(t1);

        const l2=document.createElement('div'); l2.className='l2';

        const cHref = cUrl || urlFromText(cText);
        if (cHref) {
          const aC=document.createElement('a');
          aC.href=cHref; aC.target='_blank'; aC.rel='noopener';
          aC.className='btn-pill';
          aC.title=cText||'ãƒªãƒ³ã‚¯';
          aC.textContent=cText||'ãƒªãƒ³ã‚¯';
          l2.appendChild(aC);
        }

        const dHref = dUrl || urlFromText(dText);
        const dLabel = formatYmdLabel(dText);
        if (dHref) {
          const aD=document.createElement('a');
          aD.href=dHref; aD.target='_blank'; aD.rel='noopener';
          aD.className='btn-pill';
          aD.title=dLabel ? `å‰å› ${dLabel}` : 'å‰å›';
          aD.textContent=dLabel ? `â–¶å‰å›${dLabel}` : 'â–¶å‰å›';
          l2.appendChild(aD);
        }

        const btn=document.createElement('button'); btn.className='btn'; btn.textContent='ã‚³ãƒ”ãƒ¼';
        btn.addEventListener('click',()=>copyPair(title,artist));
        l2.appendChild(btn);

        item.appendChild(l1); item.appendChild(l2);
        lfrag.appendChild(item);
      }
      listWrap.appendChild(lfrag);
      listWrap.style.display='block';
    }

    // å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆ
    $('q').addEventListener('input', scheduleSearch);
    $('limit').addEventListener('change', render);
  </script>
</body>
</html>
